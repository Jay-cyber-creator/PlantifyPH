<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenLeaf - Plant Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Poppins", sans-serif;
      }
      .hero-bg {
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
          url("https://images.unsplash.com/photo-1416879595882-3373a0480b5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80");
        background-size: cover;
        background-position: center;
      }
      .cart-notification {
        transition: all 0.3s ease;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #16a34a;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .cart-sidebar {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
      }
      .cart-sidebar.open {
        transform: translateX(0);
      }
      .backdrop {
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-in-out;
      }
      .backdrop.open {
        opacity: 1;
        visibility: visible;
      }
      .stock-low {
        color: #dc2626;
        font-weight: 500;
      }
      .stock-out {
        color: #dc2626;
        font-weight: 600;
      }
      .stock-good {
        color: #16a34a;
        font-weight: 500;
      }
      .delivery-option {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      .delivery-option.selected {
        border-color: #16a34a;
        background-color: #f0fdf4;
      }
      .delivery-option input[type="radio"] {
        display: none;
      }
      .time-slot {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }
      .time-slot.selected {
        border-color: #16a34a;
        background-color: #f0fdf4;
      }
      .time-slot.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #f3f4f6;
      }
      .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      .date-tab {
        padding: 0.5rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .date-tab.selected {
        border-color: #16a34a;
        background-color: #f0fdf4;
        color: #16a34a;
        font-weight: 600;
      }
      .date-tabs-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .user-dropdown {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
      }
      .user-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      /* Order Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }
      .status-confirmed {
        background-color: #dbeafe;
        color: #1e40af;
      }
      .status-processing {
        background-color: #e9d5ff;
        color: #6b21a8;
      }
      .status-ready {
        background-color: #dcfce7;
        color: #166534;
      }
      .status-shipped {
        background-color: #e0e7ff;
        color: #3730a3;
      }
      .status-delivered {
        background-color: #dcfce7;
        color: #166534;
      }
      .status-cancelled {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .status-timeline {
        position: relative;
        padding-left: 2rem;
      }
      .status-timeline::before {
        content: "";
        position: absolute;
        left: 0.75rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
      }
      .status-dot {
        position: absolute;
        left: 0.5rem;
        top: 0.25rem;
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background-color: #6b7280;
      }
      .status-dot.active {
        background-color: #16a34a;
        transform: scale(1.2);
      }
      /* Customer-specific styles */
      .customer-badge {
        background-color: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
      }
      .customer-features {
        border-left: 4px solid #10b981;
        padding-left: 1rem;
        margin: 1rem 0;
      }
      .wishlist-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }
      .wishlist-btn:hover {
        transform: scale(1.1);
      }
      .wishlist-btn.active {
        color: #dc2626;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        z-index: 1000;
        transition: all 0.3s ease;
        transform: translateX(100%);
        opacity: 0;
      }
      .notification.show {
        transform: translateX(0);
        opacity: 1;
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #dc2626;
      }
      .notification.info {
        background-color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-green-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <div class="flex items-center space-x-2">
          <i class="fas fa-leaf text-green-600 text-2xl"></i>
          <h1 class="text-2xl font-bold text-green-800">GreenLeaf</h1>
        </div>

        <nav class="hidden md:flex space-x-8">
          <a
            href="#"
            class="text-green-800 font-medium hover:text-green-600 transition"
            >Home</a
          >
          <a
            href="#"
            class="text-gray-600 font-medium hover:text-green-600 transition"
            >Shop</a
          >
          <a
            href="#"
            class="text-gray-600 font-medium hover:text-green-600 transition"
            >Categories</a
          >
          <a
            href="#"
            class="text-gray-600 font-medium hover:text-green-600 transition"
            >About</a
          >
          <a
            href="#"
            class="text-gray-600 font-medium hover:text-green-600 transition"
            >Contact</a
          >
        </nav>

        <div class="flex items-center space-x-4">
          <div class="relative">
            <button id="open-search-btn" class="text-gray-600 hover:text-green-600 transition">
              <i class="fas fa-search text-xl"></i>
            </button>
            <!-- Inline search for md+ screens -->
            <div id="search-wrapper" class="absolute right-0 mt-2 hidden md:block z-50">
              <div class="flex items-center bg-white rounded shadow px-2 py-1">
                <input id="search-input" type="text" placeholder="Search plants..." class="px-2 py-1 w-64 md:w-64 lg:w-80 outline-none text-sm" />
                <button id="clear-search" class="text-gray-500 hover:text-gray-700 ml-2">&times;</button>
              </div>
              <!-- Live search results dropdown - positioned below input -->
              <div id="search-results" class="absolute right-0 top-full mt-1 w-72 bg-white rounded shadow-lg max-h-64 overflow-y-auto hidden z-50"></div>
            </div>
          </div>

          <!-- Mobile search modal (small screens) -->
          <div id="mobile-search-modal" class="fixed inset-0 bg-white z-50 p-4 hidden md:hidden flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-green-800">Search Plants</h3>
              <button id="mobile-search-close" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="mb-4">
              <input id="mobile-search-input" type="search" placeholder="Search plants, e.g. fern, succulent, <500" class="w-full px-4 py-3 border rounded-md outline-none" />
            </div>
            <!-- Mobile search results dropdown -->
            <div id="mobile-search-results" class="flex-1 border rounded-md bg-gray-50 overflow-y-auto hidden mb-4"></div>
            <div class="text-right">
              <button id="mobile-search-clear" class="px-4 py-2 bg-gray-200 rounded">Clear</button>
            </div>
          </div>

          <!-- User Dropdown -->
          <div class="relative">
            <button
              id="user-btn"
              class="text-gray-600 hover:text-green-600 transition flex items-center"
            >
              <i class="fas fa-user text-xl"></i>
              <!-- Customer Badge -->
              <span id="customer-badge" class="customer-badge ml-1 hidden"
                >Customer</span
              >
            </button>

            <!-- User Dropdown Menu -->
            <div
              id="user-dropdown"
              class="user-dropdown absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50"
            >
              <div id="user-info" class="px-4 py-2 border-b hidden">
                <p
                  id="user-email"
                  class="text-sm font-medium text-gray-800 truncate"
                ></p>
                <p class="text-xs text-gray-500">Welcome!</p>
                <!-- Customer Role Indicator -->
                <div id="customer-role" class="hidden mt-1">
                  <span class="customer-badge">Customer Account</span>
                </div>
              </div>
              <button
                id="login-btn"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>Sign In
              </button>
              <button
                id="signup-btn"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
              >
                <i class="fas fa-user-plus mr-2"></i>Create Account
              </button>
              <div id="user-actions" class="hidden border-t mt-2 pt-2">
                <button
                  id="account-btn"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
                >
                  <i class="fas fa-user-circle mr-2"></i>My Account
                </button>
                <button
                  id="orders-btn"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
                >
                  <i class="fas fa-shopping-bag mr-2"></i>My Orders
                </button>
                <!-- Customer-specific features -->
                <div id="customer-features" class="hidden">
                  <button
                    id="wishlist-btn"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
                  >
                    <i class="fas fa-heart mr-2"></i>My Wishlist
                  </button>
                  <button
                    id="addresses-btn"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition"
                  >
                    <i class="fas fa-map-marker-alt mr-2"></i>Saved Addresses
                  </button>
                </div>
                <button
                  id="logout-btn"
                  class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition"
                >
                  <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
              </div>
            </div>
          </div>

          <div class="relative">
            <button
              id="cart-btn"
              class="text-gray-600 hover:text-green-600 transition"
            >
              <i class="fas fa-shopping-cart text-xl"></i>
            </button>
            <span
              id="cart-count"
              class="absolute -top-2 -right-2 bg-green-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
              >0</span
            >
          </div>
        </div>
      </div>
    </header>

    <!-- Login/Signup Modal -->
    <div
      id="auth-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-lg w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800" id="auth-modal-title">
              Sign In
            </h2>
            <button
              id="close-auth-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="auth-tabs" class="flex mb-6 border-b">
            <button
              id="login-tab"
              class="flex-1 py-2 font-medium text-green-800 border-b-2 border-green-800"
            >
              Login
            </button>
            <button
              id="signup-tab"
              class="flex-1 py-2 font-medium text-gray-500"
            >
              Sign Up
            </button>
          </div>

          <form id="login-form" class="space-y-4">
            <div>
              <label
                for="login-email"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Email Address
              </label>
              <input
                type="email"
                id="login-email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
            <div>
              <label
                for="login-password"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Password
              </label>
              <input
                type="password"
                id="login-password"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition"
            >
              Sign In
            </button>
          </form>

          <form id="signup-form" class="space-y-4 hidden">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  for="signup-firstname"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  First Name
                </label>
                <input
                  type="text"
                  id="signup-firstname"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label
                  for="signup-lastname"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  Last Name
                </label>
                <input
                  type="text"
                  id="signup-lastname"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
            </div>
            <div>
              <label
                for="signup-email"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Email Address
              </label>
              <input
                type="email"
                id="signup-email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
            <div>
              <label
                for="signup-password"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Password
              </label>
              <input
                type="password"
                id="signup-password"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
            <div>
              <label
                for="signup-confirm-password"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Confirm Password
              </label>
              <input
                type="password"
                id="signup-confirm-password"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
            <div>
              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="signup-customer-role"
                  checked
                  class="mr-2"
                />
                <span class="text-sm text-gray-600">
                  Register as Customer
                </span>
              </label>
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition"
            >
              Create Account
            </button>
          </form>

          <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">
              By continuing, you agree to our
              <a href="#" class="text-green-600 hover:underline">Terms</a> and
              <a href="#" class="text-green-600 hover:underline"
                >Privacy Policy</a
              >.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Modal -->
    <div
      id="account-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-lg w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">My Account</h2>
            <button
              id="close-account-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="account-info" class="space-y-4">
            <div class="flex items-center space-x-4">
              <div
                class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-user text-green-600 text-2xl"></i>
              </div>
              <div>
                <h3
                  id="account-name"
                  class="text-lg font-semibold text-green-800"
                ></h3>
                <p id="account-email" class="text-gray-600"></p>
                <div id="account-role" class="mt-1">
                  <span class="customer-badge">Customer Account</span>
                </div>
              </div>
            </div>

            <div class="border-t pt-4">
              <h4 class="font-semibold text-green-800 mb-2">Account Details</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-600">Member since:</span>
                  <span id="member-since" class="font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Orders placed:</span>
                  <span id="orders-count" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Wishlist items:</span>
                  <span id="wishlist-count" class="font-medium">0</span>
                </div>
              </div>
            </div>

            <div class="customer-features">
              <h4 class="font-semibold text-green-800 mb-2">
                Customer Features
              </h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>
                  <i class="fas fa-heart text-red-500 mr-2"></i>Save favorite
                  plants to wishlist
                </li>
                <li>
                  <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>Save
                  multiple delivery addresses
                </li>
                <li>
                  <i class="fas fa-history text-green-500 mr-2"></i>Track order
                  history
                </li>
                <li>
                  <i class="fas fa-tag text-yellow-500 mr-2"></i>Exclusive
                  customer offers
                </li>
              </ul>
            </div>

            <div class="border-t pt-4">
              <button
                id="view-orders-btn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition mb-2"
              >
                <i class="fas fa-shopping-bag mr-2"></i>View My Orders
              </button>
              <button
                id="view-wishlist-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition mb-2"
              >
                <i class="fas fa-heart mr-2"></i>View Wishlist
              </button>
              <button
                id="manage-addresses-btn"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition mb-2"
              >
                <i class="fas fa-map-marker-alt mr-2"></i>Manage Addresses
              </button>
              <button
                id="logout-from-account-btn"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Modal -->
    <div
      id="orders-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">My Orders</h2>
            <button
              id="close-orders-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="orders-container">
            <div class="text-center py-8">
              <div class="loading mx-auto mb-4"></div>
              <p class="text-gray-600">Loading your orders...</p>
            </div>
          </div>

          <div class="mt-6 text-center">
            <button
              id="close-orders-btn"
              class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Sidebar -->
    <div
      id="cart-backdrop"
      class="backdrop fixed inset-0 bg-black bg-opacity-50 z-50"
    ></div>
    <div
      id="cart-sidebar"
      class="cart-sidebar fixed top-0 right-0 h-full w-full md:w-96 bg-white shadow-2xl z-50 overflow-y-auto"
    >
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-green-800">Your Cart</h2>
          <button id="close-cart" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div id="cart-items" class="mb-6">
          <!-- Cart items will be loaded here -->
          <div class="text-center py-8">
            <i class="fas fa-shopping-cart text-gray-300 text-4xl mb-4"></i>
            <p class="text-gray-500">Your cart is empty</p>
          </div>
        </div>

        <div class="border-t pt-4">
          <div class="flex justify-between mb-2">
            <span class="text-gray-600">Subtotal</span>
            <span id="cart-subtotal" class="font-semibold">₱0</span>
          </div>
          <div class="flex justify-between mb-2">
            <span class="text-gray-600">Shipping</span>
            <span id="cart-shipping" class="font-semibold">₱0</span>
          </div>
          <div class="flex justify-between mb-4 text-lg">
            <span class="font-semibold">Total</span>
            <span id="cart-total" class="font-bold text-green-700">₱0</span>
          </div>

          <button
            id="checkout-btn"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Proceed to Checkout
          </button>
        </div>
      </div>
    </div>

    <!-- Checkout Modal -->
    <div
      id="checkout-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">Checkout</h2>
            <button
              id="close-checkout-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <form id="checkout-form">
            <!-- Customer Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Customer Information
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    for="first-name"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    First Name *
                  </label>
                  <input
                    type="text"
                    id="first-name"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
                <div>
                  <label
                    for="last-name"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    Last Name *
                  </label>
                  <input
                    type="text"
                    id="last-name"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
              </div>

              <div class="mt-4">
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  Email Address *
                </label>
                <input
                  type="email"
                  id="email"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>

              <div class="mt-4">
                <label
                  for="phone"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  Phone Number *
                </label>
                <input
                  type="tel"
                  id="phone"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
            </div>

            <!-- Delivery Method -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Delivery Method
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="delivery-option" id="pickup-option">
                  <input type="radio" name="delivery-method" value="pickup" />
                  <div class="flex items-center">
                    <i class="fas fa-store text-green-600 text-2xl mr-3"></i>
                    <div>
                      <h4 class="font-semibold text-green-800">Store Pickup</h4>
                      <p class="text-sm text-gray-600 mt-1">
                        Pick up your order at our store
                      </p>
                      <p class="text-sm font-semibold text-green-700 mt-1">
                        FREE
                      </p>
                    </div>
                  </div>
                </label>

                <label class="delivery-option selected" id="delivery-option">
                  <input
                    type="radio"
                    name="delivery-method"
                    value="delivery"
                    checked
                  />
                  <div class="flex items-center">
                    <i class="fas fa-truck text-green-600 text-2xl mr-3"></i>
                    <div>
                      <h4 class="font-semibold text-green-800">
                        Home Delivery
                      </h4>
                      <p class="text-sm text-gray-600 mt-1">
                        We deliver to your address
                      </p>
                      <p class="text-sm font-semibold text-green-700 mt-1">
                        ₱100 (Free over ₱1,500)
                      </p>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Pickup Time Slots - Only show for pickup -->
            <div id="pickup-time-slots-section" class="mb-6 hidden">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Select Pickup Date & Time
              </h3>
              <p class="text-sm text-gray-600 mb-4">
                Please select your preferred pickup date and time. Orders are
                usually ready for pickup in 1-2 hours.
              </p>

              <!-- Date Tabs -->
              <div id="date-tabs-container" class="date-tabs-container">
                <!-- Date tabs will be loaded here -->
              </div>

              <!-- Time Slots Grid -->
              <div id="time-slots-container" class="time-slots-grid">
                <!-- Time slots will be loaded here -->
                <div class="text-center py-4 col-span-2">
                  <div class="loading mx-auto mb-2"></div>
                  <p class="text-gray-500 text-sm">
                    Select a date to view available time slots
                  </p>
                </div>
              </div>

              <div
                class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg"
              >
                <div class="flex items-start">
                  <i class="fas fa-info-circle text-blue-500 mt-1 mr-2"></i>
                  <div>
                    <p class="text-sm text-blue-700 font-medium">
                      Store Information
                    </p>
                    <p class="text-xs text-blue-600 mt-1">
                      Address: 123 Plant Street, Green City, Metro Manila<br />
                      Hours: Mon-Sat 9:00 AM - 6:00 PM
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Shipping Address - Only show for delivery -->
            <div id="shipping-address-section" class="mb-6">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Shipping Address
              </h3>

              <!-- Saved Addresses Dropdown -->
              <div id="saved-addresses-section" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Use Saved Address
                </label>
                <select
                  id="saved-address-select"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                >
                  <option value="">Select a saved address</option>
                </select>
                <div class="mt-2 text-right">
                  <button
                    type="button"
                    id="manage-addresses-checkout-btn"
                    class="text-sm text-green-600 hover:text-green-800"
                  >
                    Manage Addresses
                  </button>
                </div>
              </div>

              <div class="mb-4">
                <label
                  for="address"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  Street Address *
                </label>
                <input
                  type="text"
                  id="address"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label
                    for="city"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    City *
                  </label>
                  <input
                    type="text"
                    id="city"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
                <div>
                  <label
                    for="province"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    Province *
                  </label>
                  <input
                    type="text"
                    id="province"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
                <div>
                  <label
                    for="zip-code"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    ZIP Code *
                  </label>
                  <input
                    type="text"
                    id="zip-code"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
              </div>

              <!-- Save Address Option -->
              <div id="save-address-section" class="hidden">
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    id="save-address-checkbox"
                    class="mr-2"
                  />
                  <span class="text-sm text-gray-600">
                    Save this address for future orders
                  </span>
                </label>
                <div class="mt-2 hidden" id="address-label-section">
                  <label
                    for="address-label-input"
                    class="block text-sm font-medium text-gray-700 mb-1"
                  >
                    Address Label (e.g., Home, Office)
                  </label>
                  <input
                    type="text"
                    id="address-label-input"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="Home"
                  />
                </div>
              </div>
            </div>

            <!-- Order Summary -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Order Summary
              </h3>
              <div class="bg-green-50 rounded-lg p-4">
                <div id="checkout-items" class="mb-4">
                  <!-- Checkout items will be loaded here -->
                </div>
                <div class="border-t pt-2">
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal</span>
                    <span id="checkout-subtotal" class="font-semibold">₱0</span>
                  </div>
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Shipping</span>
                    <span id="checkout-shipping" class="font-semibold">₱0</span>
                  </div>
                  <div class="flex justify-between text-lg font-bold">
                    <span>Total</span>
                    <span id="checkout-total" class="text-green-700">₱0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Method - COD Only -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-green-800 mb-4">
                Payment Method
              </h3>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i
                    class="fas fa-money-bill-wave text-blue-600 text-2xl mr-3"
                  ></i>
                  <div>
                    <h4 class="font-semibold text-blue-800">
                      Cash on Delivery (COD)
                    </h4>
                    <p class="text-sm text-blue-600 mt-1">
                      Pay when you receive your order
                    </p>
                  </div>
                </div>
                <input type="hidden" name="payment-method" value="cod" />
              </div>
              <p class="text-sm text-gray-600 mt-2">
                <span id="payment-instruction">
                  Our delivery partner will collect payment when your plants are
                  delivered.
                </span>
              </p>
            </div>

            <!-- Terms and Conditions -->
            <div class="mb-6">
              <label class="flex items-start">
                <input
                  type="checkbox"
                  id="terms-checkbox"
                  required
                  class="mr-2 mt-1"
                />
                <span class="text-sm text-gray-600">
                  I agree to the
                  <a href="#" class="text-green-600 hover:underline"
                    >Terms and Conditions</a
                  >
                  and
                  <a href="#" class="text-green-600 hover:underline"
                    >Privacy Policy</a
                  >
                  *
                </span>
              </label>
            </div>

            <!-- Submit Button -->
            <div class="flex space-x-4">
              <button
                type="button"
                id="cancel-checkout"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="confirm-order"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition"
              >
                <span id="confirm-order-text">Place Order (COD)</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Wishlist Modal -->
    <div
      id="wishlist-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">My Wishlist</h2>
            <button
              id="close-wishlist-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="wishlist-container">
            <div class="text-center py-8">
              <div class="loading mx-auto mb-4"></div>
              <p class="text-gray-600">Loading your wishlist...</p>
            </div>
          </div>

          <div class="mt-6 text-center">
            <button
              id="close-wishlist-btn"
              class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved Addresses Modal -->
    <div
      id="addresses-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">Saved Addresses</h2>
            <button
              id="close-addresses-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="addresses-container">
            <div class="text-center py-8">
              <div class="loading mx-auto mb-4"></div>
              <p class="text-gray-600">Loading your addresses...</p>
            </div>
          </div>

          <div class="mt-6">
            <button
              id="add-address-btn"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition mb-4"
            >
              <i class="fas fa-plus mr-2"></i>Add New Address
            </button>
            <div class="text-center">
              <button
                id="close-addresses-btn"
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Address Modal -->
    <div
      id="add-address-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-lg w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-green-800">Add New Address</h2>
            <button
              id="close-add-address-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <form id="add-address-form" class="space-y-4">
            <div>
              <label
                for="address-label"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Address Label (e.g., Home, Office)
              </label>
              <input
                type="text"
                id="address-label"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                placeholder="Home"
              />
            </div>

            <div>
              <label
                for="address-street"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Street Address *
              </label>
              <input
                type="text"
                id="address-street"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label
                  for="address-city"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  City *
                </label>
                <input
                  type="text"
                  id="address-city"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label
                  for="address-province"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  Province *
                </label>
                <input
                  type="text"
                  id="address-province"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label
                  for="address-zip"
                  class="block text-sm font-medium text-gray-700 mb-1"
                >
                  ZIP Code *
                </label>
                <input
                  type="text"
                  id="address-zip"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                />
              </div>
            </div>

            <div class="flex items-center">
              <input type="checkbox" id="default-address" class="mr-2" />
              <label for="default-address" class="text-sm text-gray-600">
                Set as default address
              </label>
            </div>

            <div class="flex space-x-4 mt-6">
              <button
                type="button"
                id="cancel-add-address"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition"
              >
                Save Address
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Hero Section -->
    <section class="hero-bg text-white py-20 md:py-32">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-4xl md:text-6xl font-bold mb-6">
          Bring Nature Into Your Home
        </h2>
        <p class="text-xl md:text-2xl mb-8 max-w-2xl mx-auto">
          Discover our wide variety of indoor and outdoor plants to create your
          perfect green space.
        </p>
        <button
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105"
        >
          Shop Now
        </button>
      </div>
    </section>

    <!-- Customer Benefits Section -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center text-green-800 mb-12">
          Customer Benefits
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-heart text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">Wishlist</h3>
            <p class="text-gray-600">
              Save your favorite plants and get notified when they're back in
              stock or on sale.
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-map-marker-alt text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Saved Addresses
            </h3>
            <p class="text-gray-600">
              Save multiple delivery addresses for faster checkout.
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-history text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Order History
            </h3>
            <p class="text-gray-600">
              Track all your orders and easily reorder your favorite plants.
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-tag text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Exclusive Offers
            </h3>
            <p class="text-gray-600">
              Get special discounts and early access to new plant arrivals.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Categories Section -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center text-green-800 mb-12">
          Plant Categories
        </h2>
        <div
          id="categories-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8"
        >
          <div class="text-center py-8 col-span-full">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Loading categories from Firebase...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured Plants -->
    <section class="py-16 bg-green-50">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center text-green-800 mb-12">
          Featured Plants
        </h2>
        <div
          id="featured-plants-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
          <div class="text-center py-8 col-span-full">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Loading plants from Firebase...</p>
          </div>
        </div>

        <div class="text-center mt-12">
          <button
            class="bg-white border-2 border-green-600 text-green-600 hover:bg-green-600 hover:text-white font-bold py-3 px-8 rounded-full text-lg transition"
          >
            View All Plants
          </button>
        </div>
      </div>
    </section>

    <!-- All Plants Section -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center text-green-800 mb-12">
          All Plants
        </h2>
        <div
          id="all-plants-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"
        >
          <div class="text-center py-8 col-span-full">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Loading plants from Firebase...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Why Choose Us -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center text-green-800 mb-12">
          Why Choose GreenLeaf?
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-shipping-fast text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Free Shipping
            </h3>
            <p class="text-gray-600">
              Free delivery for orders over ₱1,500 anywhere in the Philippines.
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-store text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Store Pickup
            </h3>
            <p class="text-gray-600">
              Pick up your order at our store for free. No shipping fees!
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="fas fa-money-bill-wave text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800 mb-2">
              Cash on Delivery
            </h3>
            <p class="text-gray-600">
              Pay when you receive your plants. No upfront payment required.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-green-900 text-white py-12">
      <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <div class="flex items-center space-x-2 mb-4">
              <i class="fas fa-leaf text-green-400 text-2xl"></i>
              <h3 class="text-2xl font-bold">GreenLeaf</h3>
            </div>
            <p class="text-green-200">
              Bringing nature closer to you with quality plants and excellent
              service.
            </p>
            <div class="mt-4">
              <h4 class="font-bold mb-2">Store Address:</h4>
              <p class="text-green-200">
                123 Plant Street, Green City, Metro Manila
              </p>
              <p class="text-green-200">Open: Mon-Sat, 9AM-6PM</p>
            </div>
          </div>

          <div>
            <h4 class="text-lg font-bold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Home</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Shop</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >About Us</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Contact</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-bold mb-4">Customer Service</h4>
            <ul class="space-y-2">
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Shipping Info</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Store Pickup</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Returns</a
                >
              </li>
              <li>
                <a href="#" class="text-green-200 hover:text-white transition"
                  >Privacy Policy</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-bold mb-4">Contact Us</h4>
            <ul class="space-y-2">
              <li class="flex items-center">
                <i class="fas fa-map-marker-alt mr-2 text-green-400"></i>
                <span class="text-green-200">123 Plant Street, Green City</span>
              </li>
              <li class="flex items-center">
                <i class="fas fa-phone mr-2 text-green-400"></i>
                <span class="text-green-200">+63 912 345 6789</span>
              </li>
              <li class="flex items-center">
                <i class="fas fa-envelope mr-2 text-green-400"></i>
                <span class="text-green-200">hello@greenleaf.com</span>
              </li>
            </ul>
          </div>
        </div>

        <div
          class="border-t border-green-800 mt-8 pt-8 text-center text-green-400"
        >
          <p>
            &copy; 2023 GreenLeaf Plant Ordering System. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    <!-- Cart Notification -->
    <div
      id="cart-notification"
      class="fixed top-20 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg cart-notification opacity-0 transform translate-x-full transition-all duration-500 z-50"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span>Item added to cart!</span>
      </div>
    </div>

    <!-- Stock Notification -->
    <div
      id="stock-notification"
      class="fixed top-20 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg cart-notification opacity-0 transform translate-x-full transition-all duration-500 z-50"
    >
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span id="stock-message">Insufficient stock!</span>
      </div>
    </div>

    <!-- Custom Notification -->
    <div id="custom-notification" class="notification">
      <div class="flex items-center">
        <i class="fas fa-info-circle mr-2"></i>
        <span id="notification-message"></span>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBg58jJLGeQDjt74-Rm7YW9OYJtlyILLc8",
        authDomain: "plantifyph-ea852.firebaseapp.com",
        databaseURL: "https://plantifyph-ea852-default-rtdb.firebaseio.com",
        projectId: "plantifyph-ea852",
        storageBucket: "plantifyph-ea852.firebasestorage.app",
        messagingSenderId: "314481205406",
        appId: "1:314481205406:web:902aaffb32026d118a9b8f",
        measurementId: "G-JQP0GSLRY8",
      };

      // Initialize Firebase
      let database, auth;
      try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        auth = firebase.auth();
        console.log("Firebase initialized successfully", {
          databaseURL: firebaseConfig.databaseURL,
          projectId: firebaseConfig.projectId
        });
      } catch (error) {
        console.error("Firebase initialization error:", error);
      }

      // Cart functionality
      let cartCount = 0;
      let cartItems = {};
      let cartTotal = 0;
      let plantsData = {};
      let selectedDeliveryMethod = "delivery";
      let selectedTimeSlot = null;
      let selectedDate = null;
      let timeSlotsData = [];
      let currentUser = null;
      let pendingPlantId = null; // Store plant ID when user needs to login
      let userOrdersQuery = null; // realtime query for user orders

      let cartDbRef = null; // realtime ref for current user's cart
      let currentSearchQuery = "";
      let pendingSearchQuery = null;

      // Customer-specific data
      let wishlistData = {};
      let savedAddresses = {};
      let addressesRef = null; // realtime ref for saved addresses
      let wishlistRef = null; // realtime ref for wishlist

      // DOM Elements
      const cartCountElement = document.getElementById("cart-count");
      const cartNotification = document.getElementById("cart-notification");
      const stockNotification = document.getElementById("stock-notification");
      const stockMessage = document.getElementById("stock-message");
      const cartSidebar = document.getElementById("cart-sidebar");
      const openSearchBtn = document.getElementById("open-search-btn");
      const searchWrapper = document.getElementById("search-wrapper");
      const searchInput = document.getElementById("search-input");
      const clearSearchBtn = document.getElementById("clear-search");
      const mobileSearchModal = document.getElementById("mobile-search-modal");
      const mobileSearchInput = document.getElementById("mobile-search-input");
      const mobileSearchClose = document.getElementById("mobile-search-close");
      const mobileSearchClear = document.getElementById("mobile-search-clear");
      const cartBackdrop = document.getElementById("cart-backdrop");
      const closeCartBtn = document.getElementById("close-cart");
      const cartItemsContainer = document.getElementById("cart-items");
      const cartSubtotalElement = document.getElementById("cart-subtotal");
      const cartShippingElement = document.getElementById("cart-shipping");
      const cartTotalElement = document.getElementById("cart-total");
      const checkoutBtn = document.getElementById("checkout-btn");

      // Auth modal elements
      const authModal = document.getElementById("auth-modal");
      const closeAuthModalBtn = document.getElementById("close-auth-modal");
      const authModalTitle = document.getElementById("auth-modal-title");
      const loginTab = document.getElementById("login-tab");
      const signupTab = document.getElementById("signup-tab");
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const customerRoleCheckbox = document.getElementById(
        "signup-customer-role"
      );

      // User dropdown elements
      const userBtn = document.getElementById("user-btn");
      const userDropdown = document.getElementById("user-dropdown");
      const userInfo = document.getElementById("user-info");
      const userEmail = document.getElementById("user-email");
      const loginBtn = document.getElementById("login-btn");
      const signupBtn = document.getElementById("signup-btn");
      const userActions = document.getElementById("user-actions");
      const accountBtn = document.getElementById("account-btn");
      const ordersBtn = document.getElementById("orders-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const customerBadge = document.getElementById("customer-badge");
      const customerRole = document.getElementById("customer-role");
      const customerFeatures = document.getElementById("customer-features");
      const wishlistBtn = document.getElementById("wishlist-btn");
      const addressesBtn = document.getElementById("addresses-btn");

      // Account modal elements
      const accountModal = document.getElementById("account-modal");
      const closeAccountModalBtn = document.getElementById(
        "close-account-modal"
      );
      const accountName = document.getElementById("account-name");
      const accountEmail = document.getElementById("account-email");
      const accountRole = document.getElementById("account-role");
      const memberSince = document.getElementById("member-since");
      const ordersCount = document.getElementById("orders-count");
      const wishlistCount = document.getElementById("wishlist-count");
      const viewOrdersBtn = document.getElementById("view-orders-btn");
      const viewWishlistBtn = document.getElementById("view-wishlist-btn");
      const manageAddressesBtn = document.getElementById(
        "manage-addresses-btn"
      );
      const logoutFromAccountBtn = document.getElementById(
        "logout-from-account-btn"
      );

      // Orders modal elements
      const ordersModal = document.getElementById("orders-modal");
      const closeOrdersModalBtn = document.getElementById("close-orders-modal");
      const closeOrdersBtn = document.getElementById("close-orders-btn");
      const ordersContainer = document.getElementById("orders-container");

      // Checkout modal elements
      const checkoutModal = document.getElementById("checkout-modal");
      const closeCheckoutModalBtn = document.getElementById(
        "close-checkout-modal"
      );
      const cancelCheckoutBtn = document.getElementById("cancel-checkout");
      const checkoutForm = document.getElementById("checkout-form");
      const confirmOrderBtn = document.getElementById("confirm-order");
      const checkoutItemsContainer = document.getElementById("checkout-items");
      const checkoutSubtotalElement =
        document.getElementById("checkout-subtotal");
      const checkoutShippingElement =
        document.getElementById("checkout-shipping");
      const checkoutTotalElement = document.getElementById("checkout-total");
      const shippingAddressSection = document.getElementById(
        "shipping-address-section"
      );
      const pickupTimeSlotsSection = document.getElementById(
        "pickup-time-slots-section"
      );
      const pickupOption = document.getElementById("pickup-option");
      const deliveryOption = document.getElementById("delivery-option");
      const paymentInstruction = document.getElementById("payment-instruction");
      const confirmOrderText = document.getElementById("confirm-order-text");
      const termsCheckbox = document.getElementById("terms-checkbox");
      const savedAddressesSection = document.getElementById(
        "saved-addresses-section"
      );
      const savedAddressSelect = document.getElementById(
        "saved-address-select"
      );
      const manageAddressesCheckoutBtn = document.getElementById(
        "manage-addresses-checkout-btn"
      );
      const saveAddressSection = document.getElementById(
        "save-address-section"
      );
      const saveAddressCheckbox = document.getElementById(
        "save-address-checkbox"
      );
      const addressLabelSection = document.getElementById(
        "address-label-section"
      );
      const addressLabelInput = document.getElementById("address-label-input");

      // Wishlist modal elements
      const wishlistModal = document.getElementById("wishlist-modal");
      const closeWishlistModalBtn = document.getElementById(
        "close-wishlist-modal"
      );
      const closeWishlistBtn = document.getElementById("close-wishlist-btn");
      const wishlistContainer = document.getElementById("wishlist-container");

      // Addresses modal elements
      const addressesModal = document.getElementById("addresses-modal");
      const closeAddressesModalBtn = document.getElementById(
        "close-addresses-modal"
      );
      const closeAddressesBtn = document.getElementById("close-addresses-btn");
      const addressesContainer = document.getElementById("addresses-container");
      const addAddressBtn = document.getElementById("add-address-btn");

      // Add address modal elements
      const addAddressModal = document.getElementById("add-address-modal");
      const closeAddAddressModalBtn = document.getElementById(
        "close-add-address-modal"
      );
      const cancelAddAddressBtn = document.getElementById("cancel-add-address");
      const addAddressForm = document.getElementById("add-address-form");

      // Notification element
      const customNotification = document.getElementById("custom-notification");
      const notificationMessage = document.getElementById(
        "notification-message"
      );

      // Generate unique user ID for cart tracking
      function getUserId() {
        // If user is logged in, use their UID
        if (currentUser) {
          return currentUser.uid;
        }

        // Otherwise, use the anonymous user ID
        let userId = localStorage.getItem("greenleaf_userId");
        if (!userId) {
          userId =
            "user_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);
          localStorage.setItem("greenleaf_userId", userId);
        }
        return userId;
      }

      // Show notification
      function showNotification(message, type = "info") {
        notificationMessage.textContent = message;
        customNotification.className = `notification ${type} show`;

        setTimeout(() => {
          customNotification.classList.remove("show");
        }, 3000);
      }

      // Get stock status class
      function getStockStatus(stock) {
        if (stock === 0) return "stock-out";
        if (stock <= 5) return "stock-low";
        return "stock-good";
      }

      // Get stock status text
      function getStockText(stock) {
        if (stock === 0) return "Out of Stock";
        if (stock <= 5) return `Only ${stock} left!`;
        return `${stock} in stock`;
      }

      // Calculate shipping cost based on delivery method
      function calculateShipping(subtotal, method) {
        if (method === "pickup") {
          return 0;
        }
        return subtotal >= 1500 ? 0 : 100;
      }

      // Debounce helper
      function debounce(fn, wait) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      // Normalize string (remove diacritics) for reliable matching
      function normalizeString(s) {
        return (s || "").toString().normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
      }

      // Parse price value to a number (handles strings like "₱1,500" or "1,500")
      function parsePrice(p) {
        if (p == null) return 0;
        if (typeof p === "number") return p;
        const s = String(p).replace(/[^0-9.]/g, "");
        const n = Number(s);
        return isFinite(n) ? n : 0;
      }

      // Check if a plant matches a query with tokens and numeric filters
      function plantMatchesQuery(plant, query) {
        if (!plant || !query) return true;
        const q = query.trim().toLowerCase();

        // Extract numeric filters (e.g., <500, >1000, 500-1000)
        let minPrice = -Infinity;
        let maxPrice = Infinity;

        const tokens = q.split(/\s+/).filter(Boolean);
        const textTokens = [];

        tokens.forEach((t) => {
          const less = t.match(/^<\s*(\d+)$/);
          const more = t.match(/^>\s*(\d+)$/);
          const range = t.match(/^(\d+)-(\d+)$/);
          if (less) {
            maxPrice = Math.min(maxPrice, Number(less[1]));
          } else if (more) {
            minPrice = Math.max(minPrice, Number(more[1]));
          } else if (range) {
            minPrice = Math.max(minPrice, Number(range[1]));
            maxPrice = Math.min(maxPrice, Number(range[2]));
          } else if (/^under\b/.test(t) || /^below\b/.test(t)) {
            // next token might be number, but keep simple
          } else {
            textTokens.push(t);
          }
        });

        // Price check
        if (isFinite(minPrice) || isFinite(maxPrice)) {
          const price = parsePrice(plant.price);
          if (price < minPrice || price > maxPrice) return false;
        }

        // Text match: all textTokens must appear in name/description/category
        const hay = normalizeString(`${plant.name || ""} ${plant.description || ""} ${plant.category || ""}`);
        for (const tk of textTokens) {
          const nt = normalizeString(tk);
          if (!hay.includes(nt)) return false;
        }

        return true;
      }

      // Highlight matching tokens in a text using currentSearchQuery
      function highlightText(text) {
        if (!currentSearchQuery) return escapeHtml(text || "");
        const tokens = currentSearchQuery.trim().toLowerCase().split(/\s+/).filter(Boolean);
        let out = escapeHtml(text || "");
        tokens.forEach((t) => {
          // skip numeric tokens
          if (/^<?\s*\d|^>\s*\d|^\d+-\d+$/.test(t)) return;
          const re = new RegExp(t.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&"), "ig");
          out = out.replace(re, (match) => `<mark class=\"bg-yellow-200\">${match}</mark>`);
        });
        return out;
      }

      // Render live search results for mobile
      function renderMobileSearchResults(results) {
        const container = document.getElementById("mobile-search-results");
        if (!container) {
          console.warn("mobile-search-results container not found");
          return;
        }
        container.innerHTML = "";
        const ids = Object.keys(results || {});
        console.debug("renderMobileSearchResults: found", ids.length, "results");
        
        if (ids.length === 0) {
          container.classList.add("hidden");
          return;
        }

        ids.slice(0, 12).forEach((id) => {
          const p = results[id];
          const isOutOfStock = p.stock === 0;
          const stockStatus = getStockStatus(p.stock);
          const stockText = getStockText(p.stock);
          
          const item = document.createElement("div");
          item.className = "bg-white rounded-lg overflow-hidden shadow hover:shadow-md transition border border-gray-200 m-2";
          item.innerHTML = `
            <div class="h-40 bg-cover bg-center" style="background-image: url('${escapeHtml(p.image || '')}');"></div>
            <div class="p-3">
              <h3 class="font-bold text-sm text-green-800 mb-1 truncate">${highlightText(p.name || '')}</h3>
              <p class="text-xs ${stockStatus} mb-2">${stockText}</p>
              <div class="flex justify-between items-center">
                <span class="font-bold text-green-700 text-sm">₱${parsePrice(p.price).toLocaleString()}</span>
                <button class="mobile-search-add-btn bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded transition ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''}" 
                  data-plant-id="${id}"
                  ${isOutOfStock ? 'disabled' : ''}
                >
                  <i class="fas fa-cart-plus mr-1"></i>${isOutOfStock ? 'Out' : 'Add'}
                </button>
              </div>
            </div>
          `;
          
          const addBtn = item.querySelector('.mobile-search-add-btn');
          if (addBtn && !isOutOfStock) {
            addBtn.addEventListener("click", function (e) {
              e.stopPropagation();
              const plantId = this.getAttribute("data-plant-id");
              console.debug("Mobile search Add clicked for", plantId);
              addToCart(plantId);
            });
          }
          
          container.appendChild(item);
        });

        container.classList.remove("hidden");
      }

      // Render desktop search results dropdown
      function renderSearchResults(results) {
        const container = document.getElementById("search-results");
        if (!container) return;
        container.innerHTML = "";
        const ids = Object.keys(results || {});
        if (ids.length === 0) {
          container.classList.add("hidden");
          return;
        }

        // Show up to 8 results
        ids.slice(0, 8).forEach((id) => {
          const p = results[id];
          const item = document.createElement("div");
          item.className = "bg-white rounded-lg overflow-hidden shadow hover:shadow-md transition border border-gray-200 m-2";
          
          const isOutOfStock = p.stock === 0;
          const stockStatus = getStockStatus(p.stock);
          const stockText = getStockText(p.stock);
          
          item.innerHTML = `
            <div class="h-32 bg-cover bg-center" style="background-image: url('${escapeHtml(p.image || '')}');"></div>
            <div class="p-3">
              <h3 class="font-bold text-sm text-green-800 mb-1 truncate">${highlightText(p.name || '')}</h3>
              <p class="text-xs ${stockStatus} mb-2">${stockText}</p>
              <div class="flex justify-between items-center">
                <span class="font-bold text-green-700 text-sm">₱${parsePrice(p.price).toLocaleString()}</span>
                <button class="search-result-add-btn bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded transition ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''}" 
                  data-plant-id="${id}"
                  ${isOutOfStock ? 'disabled' : ''}
                >
                  <i class="fas fa-cart-plus mr-1"></i>${isOutOfStock ? 'Out' : 'Add'}
                </button>
              </div>
            </div>
          `;
          
          // Delegate click to add button
          const addBtn = item.querySelector('.search-result-add-btn');
          if (addBtn && !isOutOfStock) {
            addBtn.addEventListener("click", function (e) {
              e.stopPropagation();
              const plantId = this.getAttribute("data-plant-id");
              console.debug("Search result Add clicked for", plantId);
              addToCart(plantId);
              // Keep dropdown open so user can add multiple items
            });
          }
          
          // Clicking elsewhere scrolls to product view
          item.addEventListener("click", function (e) {
            if (e.target.closest('.search-result-add-btn')) return; // Already handled
            // Navigate to product in page
            const el = document.getElementById(`plant-${id}`);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            container.classList.add('hidden');
            if (searchWrapper) searchWrapper.classList.add('hidden');
            // Also populate main search results
            searchPlants(p.name || '');
          });
          
          container.appendChild(item);
        });

        container.classList.remove("hidden");
      }

      // Search plants by name, description or category and update displays
      function searchPlants(query) {
        const allContainer = document.getElementById("all-plants-container");
        const featuredContainer = document.getElementById("featured-plants-container");

        currentSearchQuery = (query || "").trim();

        if (!currentSearchQuery) {
          // Clear search and show all
          displayAllPlants(plantsData || {});
          displayFeaturedPlants(plantsData || {});
          return;
        }

        // If plants not loaded yet, queue the search
        if (!plantsData || Object.keys(plantsData).length === 0) {
          pendingSearchQuery = currentSearchQuery;
          allContainer.innerHTML = `
            <div class="text-center py-8 col-span-full">
              <div class="loading mx-auto mb-4"></div>
              <p class="text-gray-600">Searching... Please wait while plants load</p>
            </div>
          `;
          featuredContainer.innerHTML = "";
          return;
        }

        // Filter using plantMatchesQuery
        const results = {};
        for (const id in plantsData) {
          const p = plantsData[id];
          if (plantMatchesQuery(p, currentSearchQuery)) results[id] = p;
        }

        // Debug logging to help diagnose search issues
        try {
          console.debug("searchPlants() query=", currentSearchQuery, "matches=", Object.keys(results).length);
        } catch (e) {
          // ignore in environments where console may be removed
        }

        // Update live dropdown results
        try {
          renderSearchResults(results);
        } catch (err) {
          console.error('renderSearchResults failed', err);
        }

        if (Object.keys(results).length === 0) {
          allContainer.innerHTML = `
            <div class="text-center py-8 col-span-full">
              <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
              <p class="text-gray-600">No plants matched "${escapeHtml(currentSearchQuery)}"</p>
            </div>
          `;
          featuredContainer.innerHTML = "";
          return;
        }

        displayAllPlants(results);

        // For featured, show only featured items that match
        const featuredMatches = {};
        for (const id in results) {
          if (results[id].featured) featuredMatches[id] = results[id];
        }
        displayFeaturedPlants(Object.keys(featuredMatches).length ? featuredMatches : results);
      }

      // Return array of match entries [{id, plant}] up to `limit`
      function getSearchMatches(query, limit = 6) {
        const q = (query || '').trim();
        if (!q) return [];
        if (!plantsData) {
          console.warn("getSearchMatches: plantsData is empty");
          return [];
        }
        const matches = [];
        const plantCount = Object.keys(plantsData).length;
        console.debug("getSearchMatches: searching in", plantCount, "plants for query:", q);
        
        for (const id in plantsData) {
          const p = plantsData[id];
          if (plantMatchesQuery(p, q)) {
            matches.push({ id, plant: p });
            if (matches.length >= limit) break;
          }
        }
        console.debug("getSearchMatches: found", matches.length, "matches");
        return matches;
      }

      // Render live search dropdown under the inline search input
      function renderLiveResults(query) {
        const container = document.getElementById('search-results');
        if (!container) return;
        container.innerHTML = '';
        const matches = getSearchMatches(query, 6);
        if (!matches || matches.length === 0) {
          container.classList.add('hidden');
          return;
        }

        matches.forEach(({ id, plant }) => {
          const item = document.createElement('div');
          item.className = 'search-item flex items-center gap-3 px-3 py-2 hover:bg-gray-100 cursor-pointer';
          item.setAttribute('data-plant-id', id);
          item.innerHTML = `
            <img src="${escapeHtml(plant.image || '')}" class="w-12 h-12 object-cover rounded" />
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium text-green-800">${highlightText(plant.name)}</div>
              <div class="text-xs text-gray-500 truncate">₱${parsePrice(plant.price).toLocaleString()}</div>
            </div>
            <button class="add-result-to-cart ml-2 bg-green-600 text-white text-sm px-3 py-1 rounded" data-plant-id="${id}">Add</button>
          `;
          // Click on item opens product or adds to cart
          item.addEventListener('click', (ev) => {
            // avoid double-handling when clicking the Add button inside
            if (ev.target.closest('.add-result-to-cart')) return;
            const pid = item.getAttribute('data-plant-id');
            // perform a full search to show results page as well
            searchPlants(pid);
            container.classList.add('hidden');
          });

          // Add button inside item
          item.querySelectorAll('.add-result-to-cart').forEach((btn) => {
            btn.addEventListener('click', (ev) => {
              ev.stopPropagation();
              const pid = btn.getAttribute('data-plant-id');
              // attempt to add to cart
              console.debug('Live result addToCart', pid);
              addToCart(pid);
              container.classList.add('hidden');
            });
          });

          container.appendChild(item);
        });

        container.classList.remove('hidden');
      }

      function escapeHtml(s) {
        s = s == null ? "" : String(s);
        return s.replace(/[&<>\"']/g, function (c) {
          return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
        });
      }

      // Update cart totals and checkout summary
      function updateCartTotals() {
        let subtotal = 0;

        for (const plantId in cartItems) {
          const item = cartItems[plantId];
          subtotal += item.price * item.quantity;
        }

        const shipping = calculateShipping(subtotal, selectedDeliveryMethod);
        const total = subtotal + shipping;

        cartSubtotalElement.textContent = `₱${subtotal.toLocaleString()}`;
        cartShippingElement.textContent =
          shipping === 0 ? "FREE" : `₱${shipping}`;
        cartTotalElement.textContent = `₱${total.toLocaleString()}`;

        checkoutBtn.disabled = subtotal === 0;

        // Also update checkout summary if modal is open
        if (!checkoutModal.classList.contains("hidden")) {
          updateCheckoutSummary();
        }

        return { subtotal, shipping, total };
      }

      // Load cart from Firebase
      function loadCart() {
        if (!database) {
          console.error("Database not initialized");
          return;
        }

        const userId = getUserId();
        console.log("📦 loadCart: setting up real-time listeners for userId:", userId);

        // Detach previous cart listeners if any
        try {
          if (cartDbRef) {
            cartDbRef.off();
            console.log("📦 loadCart: detached previous listeners");
          }
        } catch (err) {
          console.warn("Error detaching previous cart listeners:", err);
        }

        cartDbRef = database.ref("cart/" + userId);

        // Keep local cart cache in sync using granular child events
        cartDbRef.on("child_added", (snap) => {
          console.log("📦 CART REAL-TIME: child_added", snap.key, snap.val());
          cartItems[snap.key] = snap.val();
          recalcCartCount();
          updateCartDisplay();
          updateCartTotals();
        });

        cartDbRef.on("child_changed", (snap) => {
          console.log("📦 CART REAL-TIME: child_changed", snap.key, snap.val());
          cartItems[snap.key] = snap.val();
          recalcCartCount();
          updateCartDisplay();
          updateCartTotals();
        });

        cartDbRef.on("child_removed", (snap) => {
          console.log("📦 CART REAL-TIME: child_removed", snap.key);
          delete cartItems[snap.key];
          recalcCartCount();
          updateCartDisplay();
          updateCartTotals();
        });

        // Initial populate
        cartDbRef.once("value").then((snapshot) => {
          const cartData = snapshot.val();
          cartItems = cartData || {};
          recalcCartCount();
          updateCartDisplay();
          updateCartTotals();
        });
      }

      function recalcCartCount() {
        cartCount = 0;
        for (const plantId in cartItems) {
          cartCount += cartItems[plantId].quantity || 0;
        }
        cartCountElement.textContent = cartCount;
      }

      // Update cart display
      function updateCartDisplay() {
        cartItemsContainer.innerHTML = "";

        if (Object.keys(cartItems).length === 0) {
          cartItemsContainer.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-shopping-cart text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">Your cart is empty</p>
              </div>
            `;
          return;
        }

        for (const plantId in cartItems) {
          const item = cartItems[plantId];
          const plantStock = plantsData[plantId]?.stock || 0;
          const maxQuantity = Math.min(plantStock, 10);
          const isOutOfStock = plantStock === 0;

          const itemElement = document.createElement("div");
          itemElement.className = "flex items-center space-x-4 py-4 border-b";
          itemElement.innerHTML = `
              <img src="${item.image}" alt="${
            item.name
          }" class="w-16 h-16 object-cover rounded-lg">
              <div class="flex-1">
                <h3 class="font-semibold text-green-800">${item.name}</h3>
                <p class="text-green-600 font-bold">₱${item.price.toLocaleString()}</p>
                <p class="text-sm ${getStockStatus(plantStock)}">
                  ${getStockText(plantStock)}
                </p>
                <div class="flex items-center space-x-2 mt-2">
                  <button class="quantity-btn decrease bg-gray-200 hover:bg-gray-300 w-6 h-6 rounded flex items-center justify-center ${
                    item.quantity <= 1 ? "opacity-50 cursor-not-allowed" : ""
                  }" data-plant-id="${plantId}" ${
            item.quantity <= 1 ? "disabled" : ""
          }>
                    <i class="fas fa-minus text-xs"></i>
                  </button>
                  <span class="quantity-display w-8 text-center">${
                    item.quantity
                  }</span>
                  <button class="quantity-btn increase bg-gray-200 hover:bg-gray-300 w-6 h-6 rounded flex items-center justify-center ${
                    item.quantity >= maxQuantity
                      ? "opacity-50 cursor-not-allowed"
                      : ""
                  }" data-plant-id="${plantId}" ${
            item.quantity >= maxQuantity ? "disabled" : ""
          }>
                    <i class="fas fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <button class="remove-item text-red-500 hover:text-red-700" data-plant-id="${plantId}">
                <i class="fas fa-trash"></i>
              </button>
            `;
          cartItemsContainer.appendChild(itemElement);
        }

        // Add event listeners
        document.querySelectorAll(".quantity-btn.increase").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            updateCartQuantity(plantId, 1);
          });
        });

        document.querySelectorAll(".quantity-btn.decrease").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            updateCartQuantity(plantId, -1);
          });
        });

        document.querySelectorAll(".remove-item").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            removeFromCart(plantId);
          });
        });

        updateCartTotals();
      }

      // Update cart quantity
      function updateCartQuantity(plantId, change) {
        if (!database) return;

        const userId = getUserId();
        const cartRef = database.ref("cart/" + userId + "/" + plantId);

        cartRef
          .transaction((currentItem) => {
            if (currentItem) {
              const newQuantity = (currentItem.quantity || 0) + change;
              const plantStock = plantsData[plantId]?.stock || 0;

              if (newQuantity <= 0) {
                updatePlantStock(plantId, -change);
                return null;
              }

              if (newQuantity > plantStock) {
                showStockNotification(
                  `Only ${plantStock} items available in stock`
                );
                return currentItem;
              }

              updatePlantStock(plantId, -change);

              return {
                ...currentItem,
                quantity: newQuantity,
                updatedAt: Date.now(),
              };
            }
            return currentItem;
          })
          .then(() => {
            // Update totals immediately after quantity change
            updateCartTotals();
          });
      }

      // Remove item from cart
      function removeFromCart(plantId) {
        if (!database) return;

        const userId = getUserId();
        const cartRef = database.ref("cart/" + userId + "/" + plantId);

        cartRef.once("value").then((snapshot) => {
          const item = snapshot.val();
          if (item && item.quantity) {
            updatePlantStock(plantId, item.quantity);
          }
          cartRef.remove().then(() => {
            // Update totals immediately after removal
            updateCartTotals();
          });
        });
      }

      // Update plant stock
      function updatePlantStock(plantId, quantityChange) {
        if (!database || !quantityChange) return;

        const plantRef = database.ref("plants/" + plantId + "/stock");

        plantRef.transaction((currentStock) => {
          if (currentStock === null) return currentStock;
          const newStock = currentStock + quantityChange;
          return Math.max(0, newStock);
        });
      }

      // Load categories
      function loadCategories() {
        const categoriesContainer = document.getElementById("categories-container");

        if (!database) {
          console.error("Database not initialized: cannot load categories");
          categoriesContainer.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
              <p class="text-gray-600">Unable to connect to Firebase. Please check your Firebase configuration.</p>
            </div>
          `;
          return;
        }

        // show loading state (in case function called separately)
        categoriesContainer.innerHTML = `
          <div class="text-center py-8">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Loading categories from Firebase...</p>
          </div>
        `;

        const categoriesRef = database.ref("categories");

        // Realtime listener
        categoriesRef.on(
          "value",
          (snapshot) => {
            const categories = snapshot.val();
            if (categories && Object.keys(categories).length > 0) {
              displayCategories(categories);
            } else {
              // No categories found — show friendly message
              categoriesContainer.innerHTML = `
                <div class="text-center py-8">
                  <i class="fas fa-folder-open text-gray-300 text-4xl mb-4"></i>
                  <h3 class="text-lg font-semibold text-gray-700 mb-2">No categories yet</h3>
                  <p class="text-gray-600 mb-4">No categories were found in Firebase. Add categories to your Realtime Database under <code>categories/</code>.</p>
                </div>
              `;
            }
          },
          (error) => {
            console.error("Error loading categories:", error);
            categoriesContainer.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                <p class="text-gray-600">Error loading categories. Check console for details.</p>
              </div>
            `;
          }
        );
      }

      // Display categories
      function displayCategories(categories) {
        const categoriesContainer = document.getElementById(
          "categories-container"
        );
        categoriesContainer.innerHTML = "";

        for (const key in categories) {
          const category = categories[key];
          const categoryElement = document.createElement("div");
          categoryElement.className =
            "bg-green-50 rounded-xl p-6 text-center shadow-md hover:shadow-lg transition cursor-pointer";
          categoryElement.innerHTML = `
              <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="${category.icon} text-green-600 text-2xl"></i>
              </div>
              <h3 class="text-xl font-semibold text-green-800 mb-2">${category.name}</h3>
              <p class="text-gray-600">${category.description}</p>
            `;
          categoriesContainer.appendChild(categoryElement);
        }
      }

      // Diagnostic function for Firebase connection
      window.diagnoseFirebase = function() {
        console.log("=== FIREBASE DIAGNOSTIC ===");
        console.log("1. Firebase initialized?", !!firebase);
        console.log("2. Database ref?", !!database);
        console.log("3. Auth initialized?", !!auth);
        console.log("4. Config:", {
          projectId: firebaseConfig.projectId,
          databaseURL: firebaseConfig.databaseURL,
          apiKey: firebaseConfig.apiKey.substring(0, 10) + "..."
        });
        
        if (!database) {
          console.error("[ERROR] Database is NOT initialized. Firebase init may have failed.");
          return;
        }
        
        // Try to read /plants
        console.log("5. Testing /plants read...");
        database.ref("plants").once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (data) {
              console.log("[SUCCESS] /plants data found:", Object.keys(data).length, "plants");
              console.log("Sample keys:", Object.keys(data).slice(0, 5));
            } else {
              console.warn("[WARNING] /plants exists but is empty or null");
            }
          })
          .catch((error) => {
            console.error("[ERROR] Error reading /plants:", error.code, error.message);
          });
      };
      
      // Log diagnostic on page load
      setTimeout(() => {
        console.log("Running Firebase diagnostic after 2 seconds...");
        diagnoseFirebase();
      }, 2000);

      // Test function for search - call testSearch("fern") in console
      window.testSearch = function(query) {
        console.log("=== TEST SEARCH ===");
        console.log("Query:", query);
        console.log("plantsData loaded?", Object.keys(plantsData).length > 0);
        console.log("Number of plants:", Object.keys(plantsData).length);
        
        if (Object.keys(plantsData).length === 0) {
          console.warn("[WARNING] No plants loaded yet. Wait for page to fully load.");
          return;
        }
        
        const matches = [];
        for (const key in plantsData) {
          const plant = plantsData[key];
          if (plantMatchesQuery(plant, query)) {
            matches.push({ id: key, name: plant.name, price: plant.price });
          }
        }
        
        console.log("Matches found:", matches.length);
        console.log("Results:", matches);
        return matches;
      };

      // Load all plants
      function loadAllPlants() {
        if (!database) {
          console.error("loadAllPlants: database is not initialized");
          return;
        }

        const plantsRef = database.ref("plants");
        console.log("loadAllPlants: listening to /plants");
        
        plantsRef.on("value", (snapshot) => {
          const plants = snapshot.val();
          console.log("loadAllPlants: received data", plants ? Object.keys(plants).length + " plants" : "null");
          
          if (plants) {
            plantsData = plants;
            displayAllPlants(plants);
            displayFeaturedPlants(plants);

            // If a search was requested before plants loaded, run it now
            if (pendingSearchQuery) {
              const q = pendingSearchQuery;
              pendingSearchQuery = null;
              searchPlants(q);
            }
          } else {
            console.warn("loadAllPlants: received null or empty data from Firebase");
            // Show a message that there are no plants in database
            const allPlantsContainer = document.getElementById("all-plants-container");
            if (allPlantsContainer) {
              allPlantsContainer.innerHTML = `
                <div class="text-center py-12 col-span-full">
                  <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                  <p class="text-gray-600">No plants in database. Please add some plants to Firebase first.</p>
                </div>
              `;
            }
          }
        }, (error) => {
          console.error("loadAllPlants: Firebase error:", error);
          const allPlantsContainer = document.getElementById("all-plants-container");
          if (allPlantsContainer) {
            allPlantsContainer.innerHTML = `
              <div class="text-center py-12 col-span-full">
                <i class="fas fa-exclamation-circle text-red-400 text-5xl mb-4"></i>
                <p class="text-red-600">Error loading plants: ${error.message}</p>
              </div>
            `;
          }
        });
      }

      // Display all plants
      function displayAllPlants(plants) {
        const allPlantsContainer = document.getElementById(
          "all-plants-container"
        );
        allPlantsContainer.innerHTML = "";
        for (const key in plants) {
          const plant = plants[key];
          const stockStatus = getStockStatus(plant.stock);
          const stockText = getStockText(plant.stock);
          const isOutOfStock = plant.stock === 0;
          const isInWishlist = wishlistData && wishlistData[key];

          // Skip if current search query filters this out
          if (currentSearchQuery && !plantMatchesQuery(plant, currentSearchQuery)) {
            continue;
          }

          const plantElement = document.createElement("div");
          plantElement.className =
            "bg-white rounded-xl overflow-hidden shadow-md hover:shadow-lg transition relative";
          const highlightedName = highlightText(plant.name);
          const highlightedDesc = highlightText(plant.description);

          plantElement.innerHTML = `
              <div class="h-48 bg-cover bg-center" style="background-image: url('${
                plant.image
              }')"></div>
              <button class="wishlist-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 ${
                isInWishlist ? "active text-red-500" : ""
              }" data-plant-id="${key}">
                <i class="${isInWishlist ? "fas" : "far"} fa-heart text-xl"></i>
              </button>
              <div class="p-6">
                <h3 class="text-xl font-bold text-green-800 mb-2">${
                  highlightedName
                }</h3>
                <p class="text-gray-600 mb-2 text-sm">${highlightedDesc}</p>
                <p class="text-sm ${stockStatus} mb-3">${stockText}</p>
                <div class="flex justify-between items-center">
                  <span class="text-2xl font-bold text-green-700">₱${plant.price.toLocaleString()}</span>
                  <button 
                    data-plant-id="${key}"
                    class="add-to-cart bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition flex items-center ${
                      isOutOfStock ? "opacity-50 cursor-not-allowed" : ""
                    }"
                    ${isOutOfStock ? "disabled" : ""}
                  >
                    <i class="fas fa-cart-plus mr-2"></i> 
                    ${isOutOfStock ? "Out of Stock" : "Add to Cart"}
                  </button>
                </div>
              </div>
            `;
          allPlantsContainer.appendChild(plantElement);
        }

        // Add wishlist event listeners
        document.querySelectorAll(".wishlist-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            toggleWishlist(plantId, this);
          });
        });
      }

      // Display featured plants
      function displayFeaturedPlants(plants) {
        const featuredContainer = document.getElementById(
          "featured-plants-container"
        );
        featuredContainer.innerHTML = "";

        for (const key in plants) {
          const plant = plants[key];
          if (!plant.featured) continue;

          // Skip if current search query filters this out
          if (currentSearchQuery && !plantMatchesQuery(plant, currentSearchQuery)) {
            continue;
          }

          const stockStatus = getStockStatus(plant.stock);
          const stockText = getStockText(plant.stock);
          const isOutOfStock = plant.stock === 0;
          const isInWishlist = wishlistData && wishlistData[key];

          const plantElement = document.createElement("div");
          plantElement.className =
            "bg-white rounded-xl overflow-hidden shadow-md hover:shadow-lg transition relative";

          const highlightedName = highlightText(plant.name);
          const highlightedDesc = highlightText(plant.description);

          plantElement.innerHTML = `
                <div class="h-56 bg-cover bg-center" style="background-image: url('${
                  plant.image
                }')"></div>
                <button class="wishlist-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 ${
                  isInWishlist ? "active text-red-500" : ""
                }" data-plant-id="${key}">
                  <i class="${
                    isInWishlist ? "fas" : "far"
                  } fa-heart text-xl"></i>
                </button>
                <div class="p-6">
                  <h3 class="text-xl font-bold text-green-800 mb-2">${
                    highlightedName
                  }</h3>
                  <p class="text-gray-600 mb-2">${highlightedDesc}</p>
                  <p class="text-sm ${stockStatus} mb-3">${stockText}</p>
                  <div class="flex justify-between items-center">
                    <span class="text-2xl font-bold text-green-700">₱${plant.price.toLocaleString()}</span>
                    <button 
                      data-plant-id="${key}"
                      class="add-to-cart bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition flex items-center ${
                        isOutOfStock ? "opacity-50 cursor-not-allowed" : ""
                      }"
                      ${isOutOfStock ? "disabled" : ""}
                    >
                      <i class="fas fa-cart-plus mr-2"></i> 
                      ${isOutOfStock ? "Out of Stock" : "Add to Cart"}
                    </button>
                  </div>
                </div>
              `;
            featuredContainer.appendChild(plantElement);
        }

        // Add wishlist event listeners
        document.querySelectorAll(".wishlist-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            toggleWishlist(plantId, this);
          });
        });
      }

      // Add to cart function
      function addToCart(plantId) {
        console.debug('✨ addToCart called for', plantId, plantsData[plantId]?.name);
        if (!database) {
          showStockNotification(
            "Database not available. Please refresh the page."
          );
          return;
        }

        // Check if user is logged in
        if (!currentUser) {
          // Store the plant ID and show login modal
          pendingPlantId = plantId;
          openAuthModal();
          return;
        }

        const userId = getUserId();
        const cartRef = database.ref("cart/" + userId + "/" + plantId);
        const plant = plantsData[plantId];
        console.log("addToCart: userId=", userId, "plant=", plant?.name);

        if (!plant) {
          console.error("Plant not found:", plantId);
          return;
        }

        if (plant.stock === 0) {
          showStockNotification("This item is out of stock");
          return;
        }

        cartRef
          .transaction((currentCartItem) => {
            if (currentCartItem) {
              const newQuantity = (currentCartItem.quantity || 0) + 1;

              if (newQuantity > plant.stock) {
                showStockNotification(
                  `Only ${plant.stock} items available in stock`
                );
                return currentCartItem;
              }

              updatePlantStock(plantId, -1);

              return {
                ...currentCartItem,
                quantity: newQuantity,
                updatedAt: Date.now(),
              };
            } else {
              updatePlantStock(plantId, -1);

              return {
                plantId: plantId,
                name: plant.name,
                price: plant.price,
                image: plant.image,
                quantity: 1,
                addedAt: Date.now(),
                updatedAt: Date.now(),
              };
            }
          })
          .then(() => {
            console.log("✅ Item added to cart successfully:", plantId);
            showStockNotification(`${plant.name} added to cart!`, "success");
            cartNotification.classList.remove("opacity-0", "translate-x-full");
            cartNotification.classList.add("opacity-100", "translate-x-0");

            setTimeout(() => {
              cartNotification.classList.remove("opacity-100", "translate-x-0");
              cartNotification.classList.add("opacity-0", "translate-x-full");
            }, 3000);
          })
          .catch((error) => {
            console.error("Error adding to cart:", error);
            showStockNotification(
              "Error adding item to cart. Please try again."
            );
          });
      }

      // Show stock notification
      function showStockNotification(message, type = "error") {
        // Use green notification for success, red for errors
        const notificationEl = type === "success" ? cartNotification : stockNotification;
        const messageEl = type === "success" ? cartNotification.querySelector("span") : stockMessage;
        
        messageEl.textContent = message;
        notificationEl.classList.remove("opacity-0", "translate-x-full");
        notificationEl.classList.add("opacity-100", "translate-x-0");

        setTimeout(() => {
          notificationEl.classList.remove("opacity-100", "translate-x-0");
          notificationEl.classList.add("opacity-0", "translate-x-full");
        }, 3000);
      }

      // Open cart sidebar
      function openCart() {
        cartSidebar.classList.add("open");
        cartBackdrop.classList.add("open");
        document.body.style.overflow = "hidden";
      }

      // Close cart sidebar
      function closeCart() {
        cartSidebar.classList.remove("open");
        cartBackdrop.classList.remove("open");
        document.body.style.overflow = "auto";
      }

      // Open auth modal
      function openAuthModal() {
        authModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close auth modal
      function closeAuthModal() {
        authModal.classList.add("hidden");
        document.body.style.overflow = "auto";
        // Reset forms
        loginForm.reset();
        signupForm.reset();
      }

      // Open account modal
      function openAccountModal() {
        // Load user data
        if (currentUser) {
          const userRef = database.ref("users/" + currentUser.uid);
          userRef.once("value").then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              accountName.textContent = `${userData.firstName} ${userData.lastName}`;
              accountEmail.textContent = currentUser.email;
              memberSince.textContent = new Date(
                userData.createdAt
              ).toLocaleDateString();

              // Set customer role
              accountRole.innerHTML =
                '<span class="customer-badge">Customer Account</span>';
            }
          });

          // Load orders count
          const ordersRef = database.ref("orders");
          ordersRef
            .orderByChild("userId")
            .equalTo(currentUser.uid)
            .once("value")
            .then((snapshot) => {
              const orders = snapshot.val();
              ordersCount.textContent = orders ? Object.keys(orders).length : 0;
            });

          // Load wishlist count
          const wishlistRef = database.ref("wishlist/" + currentUser.uid);
          wishlistRef.once("value").then((snapshot) => {
            const wishlist = snapshot.val();
            wishlistCount.textContent = wishlist
              ? Object.keys(wishlist).length
              : 0;
          });
        }

        accountModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close account modal
      function closeAccountModal() {
        accountModal.classList.add("hidden");
        document.body.style.overflow = "auto";
      }

      // Open orders modal
      function openOrdersModal() {
        if (!currentUser) {
          alert("Please log in to view your orders.");
          return;
        }
        loadUserOrders();
        ordersModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close orders modal
      function closeOrdersModal() {
        ordersModal.classList.add("hidden");
        document.body.style.overflow = "auto";

        // Unsubscribe realtime listener for user orders to avoid memory leaks
        try {
          if (userOrdersQuery) {
            userOrdersQuery.off();
            userOrdersQuery = null;
          }
        } catch (err) {
          console.warn("Error unsubscribing orders listener:", err);
        }
      }

      // Load user orders
      function loadUserOrders() {
        if (!database || !currentUser) return;

        ordersContainer.innerHTML = `
          <div class="text-center py-8">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Loading your orders...</p>
          </div>
        `;

        // Unsubscribe previous query if present
        if (userOrdersQuery) {
          try {
            userOrdersQuery.off();
          } catch (err) {
            console.warn("Error turning off previous orders listener:", err);
          }
          userOrdersQuery = null;
        }

        // Create a realtime query for the current user's orders
        try {
          userOrdersQuery = database
            .ref("orders")
            .orderByChild("userId")
            .equalTo(currentUser.uid);

          userOrdersQuery.on(
            "value",
            (snapshot) => {
              const orders = snapshot.val();
              displayOrders(orders);
            },
            (error) => {
              console.error("Error loading orders:", error);
              ordersContainer.innerHTML = `
                <div class=\"text-center py-8\">\n                  <i class=\"fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4\"></i>\n                  <p class=\"text-gray-600\">Error loading orders. Please try again.</p>\n                </div>
              `;
            }
          );
        } catch (err) {
          console.error("Failed to attach realtime orders listener:", err);
        }
      }

      // Display orders
      function displayOrders(orders) {
        ordersContainer.innerHTML = "";

        if (!orders || Object.keys(orders).length === 0) {
          ordersContainer.innerHTML = `
            <div class="text-center py-12">
              <i class="fas fa-shopping-bag text-gray-300 text-5xl mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 mb-2">No Orders Yet</h3>
              <p class="text-gray-500 mb-6">You haven't placed any orders yet.</p>
              <button
                onclick="closeOrdersModal()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition"
              >
                Start Shopping
              </button>
            </div>
          `;
          return;
        }

        // Sort orders by date (newest first)
        const sortedOrders = Object.entries(orders).sort((a, b) => {
          return b[1].createdAt - a[1].createdAt;
        });

        sortedOrders.forEach(([orderId, order]) => {
          const orderElement = document.createElement("div");
          orderElement.className =
            "bg-green-50 rounded-lg p-6 mb-6 border border-green-200";

          // Format date
          const orderDate = new Date(order.createdAt);
          const formattedDate = orderDate.toLocaleDateString("en-PH", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          // Get status color and icon
          const statusConfig = getOrderStatusConfig(order.status);

          orderElement.innerHTML = `
            <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-4">
              <div>
                <h3 class="text-lg font-bold text-green-800">Order #${
                  order.orderNumber
                }</h3>
                <p class="text-gray-600 text-sm">Placed on ${formattedDate}</p>
              </div>
              <div class="flex items-center mt-2 md:mt-0">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                  statusConfig.color
                }">
                  <i class="${statusConfig.icon} mr-1"></i>
                  ${statusConfig.text}
                </span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <h4 class="font-semibold text-green-800 mb-2">Customer Information</h4>
                <p class="text-sm text-gray-600">
                  ${order.customer.firstName} ${order.customer.lastName}<br>
                  ${order.customer.email}<br>
                  ${order.customer.phone}
                </p>
              </div>
              <div>
                <h4 class="font-semibold text-green-800 mb-2">Delivery Method</h4>
                <p class="text-sm text-gray-600">
                  ${
                    order.deliveryMethod === "pickup"
                      ? "Store Pickup"
                      : "Home Delivery"
                  }
                  ${
                    order.deliveryMethod === "pickup" &&
                    order.customer.pickupTimeSlot
                      ? `<br>${new Date(
                          order.customer.pickupDate
                        ).toLocaleDateString()} at ${
                          order.customer.pickupTimeSlot
                        }`
                      : ""
                  }
                  ${
                    order.deliveryMethod === "delivery" &&
                    order.customer.address
                      ? `<br>${order.customer.address}, ${order.customer.city}`
                      : ""
                  }
                </p>
              </div>
            </div>

            <div class="border-t pt-4">
              <h4 class="font-semibold text-green-800 mb-3">Order Items</h4>
              <div class="space-y-3">
                ${Object.values(order.items)
                  .map(
                    (item) => `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                      <img src="${item.image}" alt="${
                      item.name
                    }" class="w-12 h-12 object-cover rounded">
                      <div>
                        <p class="font-medium text-green-800">${item.name}</p>
                        <p class="text-sm text-gray-600">Quantity: ${
                          item.quantity
                        }</p>
                      </div>
                    </div>
                    <p class="font-semibold">₱${(
                      item.price * item.quantity
                    ).toLocaleString()}</p>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>

            <div class="border-t pt-4 mt-4">
              <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                  Payment Method: <span class="font-medium">${
                    order.paymentMethod === "cod"
                      ? "Cash on Delivery"
                      : order.paymentMethod
                  }</span>
                </div>
                <div class="text-right">
                  <div class="flex justify-between space-x-8 text-sm mb-1">
                    <span>Subtotal:</span>
                    <span class="font-medium">₱${order.subtotal.toLocaleString()}</span>
                  </div>
                  <div class="flex justify-between space-x-8 text-sm mb-1">
                    <span>Shipping:</span>
                    <span class="font-medium">${
                      order.shipping === 0 ? "FREE" : `₱${order.shipping}`
                    }</span>
                  </div>
                  <div class="flex justify-between space-x-8 text-lg font-bold mt-2">
                    <span>Total:</span>
                    <span class="text-green-700">₱${order.total.toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>

            ${
              order.statusHistory
                ? `
              <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold text-green-800 mb-3">Order Status Timeline</h4>
                <div class="status-timeline space-y-4">
                  ${order.statusHistory
                    .map((statusItem, index) => {
                      const statusDate = new Date(statusItem.timestamp);
                      const isActive = index === order.statusHistory.length - 1;
                      return `
                      <div class="relative">
                        <div class="status-dot ${
                          isActive ? "active" : ""
                        }"></div>
                        <div class="ml-6">
                          <div class="flex items-center space-x-2">
                            <span class="font-medium ${
                              isActive ? "text-green-700" : "text-gray-700"
                            }">${
                        getOrderStatusConfig(statusItem.status).text
                      }</span>
                            <span class="text-xs text-gray-500">${statusDate.toLocaleDateString()} ${statusDate.toLocaleTimeString()}</span>
                          </div>
                          ${
                            statusItem.note
                              ? `<p class="text-sm text-gray-600 mt-1">${statusItem.note}</p>`
                              : ""
                          }
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
            `
                : ""
            }
          `;

          ordersContainer.appendChild(orderElement);
        });
      }

      // Get order status configuration
      function getOrderStatusConfig(status) {
        const configs = {
          pending: {
            text: "Pending",
            color: "bg-yellow-100 text-yellow-800",
            icon: "fas fa-clock",
          },
          confirmed: {
            text: "Confirmed",
            color: "bg-blue-100 text-blue-800",
            icon: "fas fa-check-circle",
          },
          processing: {
            text: "Processing",
            color: "bg-purple-100 text-purple-800",
            icon: "fas fa-cog",
          },
          ready: {
            text: "Ready for Pickup",
            color: "bg-green-100 text-green-800",
            icon: "fas fa-box",
          },
          shipped: {
            text: "Shipped",
            color: "bg-indigo-100 text-indigo-800",
            icon: "fas fa-shipping-fast",
          },
          delivered: {
            text: "Delivered",
            color: "bg-green-100 text-green-800",
            icon: "fas fa-check-double",
          },
          cancelled: {
            text: "Cancelled",
            color: "bg-red-100 text-red-800",
            icon: "fas fa-times-circle",
          },
        };

        return configs[status] || configs.pending;
      }

      // Toggle user dropdown
      function toggleUserDropdown() {
        userDropdown.classList.toggle("open");
      }

      // Switch to login tab
      function showLoginTab() {
        loginTab.classList.add("text-green-800", "border-green-800");
        loginTab.classList.remove("text-gray-500");
        signupTab.classList.add("text-gray-500");
        signupTab.classList.remove("text-green-800", "border-green-800");
        loginForm.classList.remove("hidden");
        signupForm.classList.add("hidden");
        authModalTitle.textContent = "Sign In";
      }

      // Switch to signup tab
      function showSignupTab() {
        signupTab.classList.add("text-green-800", "border-green-800");
        signupTab.classList.remove("text-gray-500");
        loginTab.classList.add("text-gray-500");
        loginTab.classList.remove("text-green-800", "border-green-800");
        signupForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
        authModalTitle.textContent = "Create Account";
      }

      // Handle user login
      function handleLogin(email, password) {
        auth
          .signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            // Signed in
            currentUser = userCredential.user;
            closeAuthModal();
            updateUserUI();

            // If there was a pending plant to add to cart, add it now
            if (pendingPlantId) {
              addToCart(pendingPlantId);
              pendingPlantId = null;
            }
          })
          .catch((error) => {
            console.error("Login error:", error);
            alert("Login failed: " + error.message);
          });
      }

      // Handle user signup
      function handleSignup(firstName, lastName, email, password) {
        auth
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            // Signed up
            currentUser = userCredential.user;

            // Save user profile to database with customer role
            const userRef = database.ref("users/" + currentUser.uid);
            const userData = {
              firstName: firstName,
              lastName: lastName,
              email: email,
              role: "customer", // Set role as customer
              createdAt: Date.now(),
            };

            userRef.set(userData).then(() => {
              closeAuthModal();
              updateUserUI();

              // If there was a pending plant to add to cart, add it now
              if (pendingPlantId) {
                addToCart(pendingPlantId);
                pendingPlantId = null;
              }
            });
          })
          .catch((error) => {
            console.error("Signup error:", error);
            alert("Signup failed: " + error.message);
          });
      }

      // Handle user logout
      function handleLogout() {
        auth
          .signOut()
          .then(() => {
            currentUser = null;
            updateUserUI();
            closeAccountModal();
            userDropdown.classList.remove("open");

            // Show logout success message
            showNotification(
              "You have been logged out successfully.",
              "success"
            );
          })
          .catch((error) => {
            console.error("Logout error:", error);
            showNotification("Logout failed: " + error.message, "error");
          });
      }

      // Update UI based on user authentication status
      function updateUserUI() {
        if (currentUser) {
          // User is logged in
          userBtn.innerHTML = '<i class="fas fa-user-check text-xl"></i>';
          userBtn.title = "My Account";

          // Update user dropdown
          userInfo.classList.remove("hidden");
          userEmail.textContent = currentUser.email;
          loginBtn.classList.add("hidden");
          signupBtn.classList.add("hidden");
          userActions.classList.remove("hidden");

          // Show customer features
          customerBadge.classList.remove("hidden");
          customerRole.classList.remove("hidden");
          customerFeatures.classList.remove("hidden");

          // Update cart with user's data
          loadCart();

          // Load customer-specific data
          loadWishlist();
          loadSavedAddresses();
        } else {
          // User is not logged in
          userBtn.innerHTML = '<i class="fas fa-user text-xl"></i>';
          userBtn.title = "Sign In";

          // Update user dropdown
          userInfo.classList.add("hidden");
          loginBtn.classList.remove("hidden");
          signupBtn.classList.remove("hidden");
          userActions.classList.add("hidden");

          // Hide customer features
          customerBadge.classList.add("hidden");
          customerRole.classList.add("hidden");
          customerFeatures.classList.add("hidden");

          // Detach saved addresses listeners and clear local cache
          try {
            if (addressesRef) {
              addressesRef.off();
              addressesRef = null;
            }
          } catch (err) {
            console.warn("Error unsubscribing addresses listeners on logout:", err);
          }

          savedAddresses = {};
          updateSavedAddressesDropdown();

          // Detach wishlist listeners and clear local cache
          try {
            if (wishlistRef) {
              wishlistRef.off();
              wishlistRef = null;
            }
          } catch (err) {
            console.warn("Error unsubscribing wishlist listeners on logout:", err);
          }

          wishlistData = {};
          if (wishlistCount) wishlistCount.textContent = 0;
          if (plantsData) {
            displayAllPlants(plantsData);
            displayFeaturedPlants(plantsData);
          }
        }
      }

      // Load wishlist
      function loadWishlist() {
        if (!database || !currentUser) return;

        // Detach previous wishlist listeners if any
        try {
          if (wishlistRef) wishlistRef.off();
        } catch (err) {
          console.warn("Error removing previous wishlist listeners:", err);
        }

        wishlistRef = database.ref("wishlist/" + currentUser.uid);

        // Attach granular listeners for real-time add/change/remove
        wishlistRef.on("child_added", (snap) => {
          wishlistData[snap.key] = snap.val();
          if (wishlistCount) wishlistCount.textContent = Object.keys(wishlistData).length;
          if (plantsData) {
            displayAllPlants(plantsData);
            displayFeaturedPlants(plantsData);
          }
          if (!wishlistModal.classList.contains("hidden")) displayWishlist();
        });

        wishlistRef.on("child_changed", (snap) => {
          wishlistData[snap.key] = snap.val();
          if (wishlistCount) wishlistCount.textContent = Object.keys(wishlistData).length;
          if (plantsData) {
            displayAllPlants(plantsData);
            displayFeaturedPlants(plantsData);
          }
          if (!wishlistModal.classList.contains("hidden")) displayWishlist();
        });

        wishlistRef.on("child_removed", (snap) => {
          delete wishlistData[snap.key];
          if (wishlistCount) wishlistCount.textContent = Object.keys(wishlistData).length;
          if (plantsData) {
            displayAllPlants(plantsData);
            displayFeaturedPlants(plantsData);
          }
          if (!wishlistModal.classList.contains("hidden")) displayWishlist();
        });

        // Initial snapshot to populate local cache (covers empty state)
        wishlistRef.once("value").then((snapshot) => {
          const wishlist = snapshot.val();
          wishlistData = wishlist || {};
          if (wishlistCount) wishlistCount.textContent = wishlist ? Object.keys(wishlist).length : 0;
          if (plantsData) {
            displayAllPlants(plantsData);
            displayFeaturedPlants(plantsData);
          }
        });
      }

      // Load saved addresses
      function loadSavedAddresses() {
        if (!database || !currentUser) return;

        // Detach previous listeners if any
        try {
          if (addressesRef) {
            addressesRef.off();
          }
        } catch (err) {
          console.warn("Error removing previous addresses listeners:", err);
        }

        addressesRef = database.ref("addresses/" + currentUser.uid);

        // Use child events so updates/deletes/adds are reflected immediately
        addressesRef.on("child_added", (snap) => {
          savedAddresses[snap.key] = snap.val();
          updateSavedAddressesDropdown();
          if (!addressesModal.classList.contains("hidden")) displayAddresses();
        });

        addressesRef.on("child_changed", (snap) => {
          savedAddresses[snap.key] = snap.val();
          updateSavedAddressesDropdown();
          if (!addressesModal.classList.contains("hidden")) displayAddresses();
        });

        addressesRef.on("child_removed", (snap) => {
          delete savedAddresses[snap.key];
          updateSavedAddressesDropdown();
          if (!addressesModal.classList.contains("hidden")) displayAddresses();
        });

        // Also attach an initial value listener to cover empty states
        addressesRef.once("value").then((snapshot) => {
          const addresses = snapshot.val();
          savedAddresses = addresses || {};
          updateSavedAddressesDropdown();
        });
      }

      // Add to wishlist (always adds, updates timestamp if already present)
      function toggleWishlist(plantId, button) {
        if (!currentUser) {
          showNotification(
            "Please log in to add items to your wishlist.",
            "info"
          );
          return;
        }

        const plant = plantsData[plantId];
        if (!plant) return;

        const wishlistRef = database.ref(
          "wishlist/" + currentUser.uid + "/" + plantId
        );

        // Always add to wishlist (updates timestamp if already present)
        wishlistRef
          .set({
            plantId: plantId,
            name: plant.name,
            price: plant.price,
            image: plant.image,
            addedAt: Date.now(),
          })
          .then(() => {
            button.innerHTML = '<i class="fas fa-heart text-xl"></i>';
            button.classList.add("active");
            showNotification("Added to wishlist!", "success");
          });
      }

      // Open wishlist modal
      function openWishlistModal() {
        if (!currentUser) {
          showNotification("Please log in to view your wishlist.", "info");
          return;
        }

        displayWishlist();
        wishlistModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close wishlist modal
      function closeWishlistModal() {
        wishlistModal.classList.add("hidden");
        document.body.style.overflow = "auto";
      }

      // Display wishlist
      function displayWishlist() {
        wishlistContainer.innerHTML = "";

        if (Object.keys(wishlistData).length === 0) {
          wishlistContainer.innerHTML = `
            <div class="text-center py-12">
              <i class="fas fa-heart text-gray-300 text-5xl mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 mb-2">Your Wishlist is Empty</h3>
              <p class="text-gray-500 mb-6">Start adding your favorite plants to your wishlist!</p>
              <button
                onclick="closeWishlistModal()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition"
              >
                Start Shopping
              </button>
            </div>
          `;
          return;
        }

        for (const plantId in wishlistData) {
          const item = wishlistData[plantId];
          const plant = plantsData[plantId];
          const stockStatus = getStockStatus(plant.stock);
          const stockText = getStockText(plant.stock);
          const isOutOfStock = plant.stock === 0;

          const itemElement = document.createElement("div");
          itemElement.className =
            "bg-white rounded-lg p-6 mb-4 border border-green-200";
          itemElement.innerHTML = `
            <div class="flex items-center space-x-4">
              <img src="${item.image}" alt="${
            item.name
          }" class="w-20 h-20 object-cover rounded-lg">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-green-800">${
                  item.name
                }</h3>
                <p class="text-green-600 font-bold text-xl">₱${item.price.toLocaleString()}</p>
                <p class="text-sm ${stockStatus}">${stockText}</p>
              </div>
              <div class="flex space-x-2">
                <button 
                  data-plant-id="${plantId}"
                  class="add-to-cart-from-wishlist bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition flex items-center ${
                    isOutOfStock ? "opacity-50 cursor-not-allowed" : ""
                  }"
                  ${isOutOfStock ? "disabled" : ""}
                >
                  <i class="fas fa-cart-plus mr-2"></i> 
                  ${isOutOfStock ? "Out of Stock" : "Add to Cart"}
                </button>
                <button class="remove-from-wishlist text-red-500 hover:text-red-700" data-plant-id="${plantId}">
                  <i class="fas fa-trash text-xl"></i>
                </button>
              </div>
            </div>
          `;
          wishlistContainer.appendChild(itemElement);
        }

        // Add event listeners
        document
          .querySelectorAll(".add-to-cart-from-wishlist")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const plantId = this.getAttribute("data-plant-id");
              if (!this.disabled) {
                addToCart(plantId);
              }
            });
          });

        document.querySelectorAll(".remove-from-wishlist").forEach((btn) => {
          btn.addEventListener("click", function () {
            const plantId = this.getAttribute("data-plant-id");
            removeFromWishlist(plantId);
          });
        });
      }

      // Remove from wishlist
      function removeFromWishlist(plantId) {
        if (!database || !currentUser) return;

        const wishlistRef = database.ref(
          "wishlist/" + currentUser.uid + "/" + plantId
        );
        wishlistRef.remove().then(() => {
          showNotification("Removed from wishlist", "success");
        });
      }

      // Open addresses modal
      function openAddressesModal() {
        if (!currentUser) {
          showNotification("Please log in to manage your addresses.", "info");
          return;
        }

        displayAddresses();
        addressesModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close addresses modal
      function closeAddressesModal() {
        addressesModal.classList.add("hidden");
        document.body.style.overflow = "auto";
      }

      // Display addresses
      function displayAddresses() {
        addressesContainer.innerHTML = "";

        if (Object.keys(savedAddresses).length === 0) {
          addressesContainer.innerHTML = `
      <div class="text-center py-12">
        <i class="fas fa-map-marker-alt text-gray-300 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Saved Addresses</h3>
        <p class="text-gray-500 mb-6">Add your first address for faster checkout!</p>
      </div>
    `;
          return;
        }

        for (const addressId in savedAddresses) {
          const address = savedAddresses[addressId];
          const isDefault = address.default || false;

          const addressElement = document.createElement("div");
          addressElement.className =
            "bg-white rounded-lg p-6 mb-4 border border-green-200";
          addressElement.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <div>
          <h3 class="text-lg font-semibold text-green-800">${address.label}</h3>
          ${
            isDefault
              ? '<span class="customer-badge text-xs ml-2">Default</span>'
              : ""
          }
        </div>
        <div class="flex space-x-2">
          <button class="edit-address text-blue-500 hover:text-blue-700" data-address-id="${addressId}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-address text-red-500 hover:text-red-700" data-address-id="${addressId}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <p class="text-gray-600">
        ${address.street}<br>
        ${address.city}, ${address.province} ${address.zipCode}
      </p>
      <div class="mt-3 flex space-x-2">
        ${
          !isDefault
            ? `
          <button class="set-default-address text-xs bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded" data-address-id="${addressId}">
            Set as Default
          </button>
        `
            : ""
        }
      </div>
    `;
          addressesContainer.appendChild(addressElement);
        }

        // Add event listeners for edit, delete, and set default buttons
        document.querySelectorAll(".edit-address").forEach((btn) => {
          btn.addEventListener("click", function () {
            const addressId = this.getAttribute("data-address-id");
            editAddress(addressId);
          });
        });

        document.querySelectorAll(".delete-address").forEach((btn) => {
          btn.addEventListener("click", function () {
            const addressId = this.getAttribute("data-address-id");
            deleteAddress(addressId);
          });
        });

        document.querySelectorAll(".set-default-address").forEach((btn) => {
          btn.addEventListener("click", function () {
            const addressId = this.getAttribute("data-address-id");
            setDefaultAddress(addressId);
          });
        });
      }

      // Edit address
      function editAddress(addressId) {
        const address = savedAddresses[addressId];
        if (!address) return;

        // Populate the add address form with existing data
        document.getElementById("address-label").value = address.label;
        document.getElementById("address-street").value = address.street;
        document.getElementById("address-city").value = address.city;
        document.getElementById("address-province").value = address.province;
        document.getElementById("address-zip").value = address.zipCode;
        document.getElementById("default-address").checked =
          address.default || false;

        // Update modal title and button text
        document.querySelector("#add-address-modal h2").textContent =
          "Edit Address";
        document.querySelector(
          "#add-address-form button[type='submit']"
        ).textContent = "Update Address";

        // Store the address ID being edited
        document
          .getElementById("add-address-form")
          .setAttribute("data-editing-address-id", addressId);

        openAddAddressModal();
      }

      // Delete address
      function deleteAddress(addressId) {
        if (!currentUser) return;

        const address = savedAddresses[addressId];
        if (!address) return;

        // Confirm deletion
        if (
          confirm(
            `Are you sure you want to delete the address "${address.label}"?`
          )
        ) {
          const addressRef = database.ref(
            "addresses/" + currentUser.uid + "/" + addressId
          );

          addressRef
            .remove()
            .then(() => {
              showNotification("Address deleted successfully!", "success");

              // If the deleted address was the default, set another address as default
              if (address.default) {
                setFirstAddressAsDefault();
              }
            })
            .catch((error) => {
              console.error("Error deleting address:", error);
              showNotification(
                "Error deleting address. Please try again.",
                "error"
              );
            });
        }
      }

      // Set first address as default when default is deleted
      function setFirstAddressAsDefault() {
        const addressesRef = database.ref("addresses/" + currentUser.uid);
        addressesRef.once("value").then((snapshot) => {
          const addresses = snapshot.val();
          if (addresses && Object.keys(addresses).length > 0) {
            const firstAddressId = Object.keys(addresses)[0];
            const firstAddressRef = database.ref(
              "addresses/" + currentUser.uid + "/" + firstAddressId + "/default"
            );
            firstAddressRef.set(true);
          }
        });
      }

      // Set default address
      function setDefaultAddress(addressId) {
        if (!currentUser) return;

        const addressesRef = database.ref("addresses/" + currentUser.uid);
        addressesRef.once("value").then((snapshot) => {
          const addresses = snapshot.val();
          if (addresses) {
            const updates = {};
            for (const id in addresses) {
              updates[id + "/default"] = false;
            }
            updates[addressId + "/default"] = true;

            addressesRef.update(updates).then(() => {
              showNotification("Default address updated!", "success");
            });
          }
        });
      }

      // Open add address modal
      function openAddAddressModal() {
        addAddressForm.reset();
        addAddressModal.classList.remove("hidden");
      }

      // Close add address modal
      function closeAddAddressModal() {
        addAddressModal.classList.add("hidden");
      }

      // Handle add address form submission
      function handleAddAddress(event) {
        event.preventDefault();

        const label = document.getElementById("address-label").value;
        const street = document.getElementById("address-street").value;
        const city = document.getElementById("address-city").value;
        const province = document.getElementById("address-province").value;
        const zip = document.getElementById("address-zip").value;
        const isDefault = document.getElementById("default-address").checked;

        if (!currentUser) {
          showNotification("Please log in to save addresses.", "error");
          return;
        }

        const editingAddressId = document
          .getElementById("add-address-form")
          .getAttribute("data-editing-address-id");
        const addressId = editingAddressId || "addr_" + Date.now();
        const addressRef = database.ref(
          "addresses/" + currentUser.uid + "/" + addressId
        );

        const addressData = {
          label: label,
          street: street,
          city: city,
          province: province,
          zipCode: zip,
          default: isDefault,
          createdAt: editingAddressId
            ? savedAddresses[editingAddressId].createdAt
            : Date.now(),
        };

        // If setting as default, remove default from other addresses
        if (isDefault) {
          const addressesRef = database.ref("addresses/" + currentUser.uid);
          addressesRef.once("value").then((snapshot) => {
            const addresses = snapshot.val();
            if (addresses) {
              const updates = {};
              for (const id in addresses) {
                updates[id + "/default"] = false;
              }
              addressesRef.update(updates).then(() => {
                addressRef.set(addressData).then(() => {
                  showNotification(
                    editingAddressId
                      ? "Address updated successfully!"
                      : "Address saved successfully!",
                    "success"
                  );
                  closeAddAddressModal();
                  resetAddAddressForm();
                });
              });
            } else {
              addressRef.set(addressData).then(() => {
                showNotification(
                  editingAddressId
                    ? "Address updated successfully!"
                    : "Address saved successfully!",
                  "success"
                );
                closeAddAddressModal();
                resetAddAddressForm();
              });
            }
          });
        } else {
          addressRef.set(addressData).then(() => {
            showNotification(
              editingAddressId
                ? "Address updated successfully!"
                : "Address saved successfully!",
              "success"
            );
            closeAddAddressModal();
            resetAddAddressForm();
          });
        }
      }

      // Reset add address form
      function resetAddAddressForm() {
        document.getElementById("add-address-form").reset();
        document
          .getElementById("add-address-form")
          .removeAttribute("data-editing-address-id");
        document.querySelector("#add-address-modal h2").textContent =
          "Add New Address";
        document.querySelector(
          "#add-address-form button[type='submit']"
        ).textContent = "Save Address";
      }

      // Update saved addresses dropdown in checkout
      function updateSavedAddressesDropdown() {
        if (!currentUser) {
          savedAddressesSection.classList.add("hidden");
          return;
        }

        savedAddressSelect.innerHTML =
          '<option value="">Select a saved address</option>';

        if (Object.keys(savedAddresses).length === 0) {
          savedAddressesSection.classList.add("hidden");
          return;
        }

        savedAddressesSection.classList.remove("hidden");

        for (const addressId in savedAddresses) {
          const address = savedAddresses[addressId];
          const option = document.createElement("option");
          option.value = addressId;
          option.textContent = `${address.label} - ${address.street}, ${address.city}`;
          if (address.default) {
            option.selected = true;
            // Auto-fill the form with default address
            fillAddressForm(address);
          }
          savedAddressSelect.appendChild(option);
        }
      }

      // Fill address form with saved address
      function fillAddressForm(address) {
        document.getElementById("address").value = address.street;
        document.getElementById("city").value = address.city;
        document.getElementById("province").value = address.province;
        document.getElementById("zip-code").value = address.zipCode;
      }

      // Open checkout modal
      function openCheckoutModal() {
        if (Object.keys(cartItems).length === 0) return;

        updateCheckoutSummary();

        // Show saved addresses section for logged-in customers
        if (currentUser && Object.keys(savedAddresses).length > 0) {
          savedAddressesSection.classList.remove("hidden");
          saveAddressSection.classList.remove("hidden");
        } else {
          savedAddressesSection.classList.add("hidden");
          saveAddressSection.classList.add("hidden");
        }

        checkoutModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      // Close checkout modal
      function closeCheckoutModal() {
        checkoutModal.classList.add("hidden");
        document.body.style.overflow = "auto";
      }

      // Update checkout summary
      function updateCheckoutSummary() {
        checkoutItemsContainer.innerHTML = "";

        let subtotal = 0;

        for (const plantId in cartItems) {
          const item = cartItems[plantId];
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;

          const itemElement = document.createElement("div");
          itemElement.className = "flex justify-between items-center py-2";
          itemElement.innerHTML = `
              <div>
                <span class="font-medium">${item.name}</span>
                <span class="text-gray-600 text-sm"> x ${item.quantity}</span>
              </div>
              <span class="font-semibold">₱${itemTotal.toLocaleString()}</span>
            `;
          checkoutItemsContainer.appendChild(itemElement);
        }

        const shipping = calculateShipping(subtotal, selectedDeliveryMethod);
        const total = subtotal + shipping;

        checkoutSubtotalElement.textContent = `₱${subtotal.toLocaleString()}`;
        checkoutShippingElement.textContent =
          shipping === 0 ? "FREE" : `₱${shipping}`;
        checkoutTotalElement.textContent = `₱${total.toLocaleString()}`;
      }

      // Load pickup time slots
      function loadPickupTimeSlots() {
        if (!database) return;

        const storeRef = database.ref("store/pickupInfo/timeSlots");
        storeRef.on("value", (snapshot) => {
          const slots = snapshot.val();
          if (slots) {
            timeSlotsData = slots;
            displayDateTabs(slots);
          }
        });
      }

      // Display date tabs
      function displayDateTabs(slots) {
        const dateTabsContainer = document.getElementById(
          "date-tabs-container"
        );
        dateTabsContainer.innerHTML = "";

        const uniqueDates = [...new Set(slots.map((slot) => slot.date))];

        uniqueDates.forEach((date) => {
          const dateTab = document.createElement("div");
          dateTab.className = "date-tab";
          dateTab.setAttribute("data-date", date);

          const dateObj = new Date(date);
          const formattedDate = dateObj.toLocaleDateString("en-PH", {
            weekday: "short",
            month: "short",
            day: "numeric",
          });

          dateTab.innerHTML = formattedDate;
          dateTabsContainer.appendChild(dateTab);

          dateTab.addEventListener("click", function () {
            selectDate(date);
          });
        });

        if (uniqueDates.length > 0) {
          selectDate(uniqueDates[0]);
        }
      }

      // Select date and display time slots
      function selectDate(date) {
        selectedDate = date;

        document.querySelectorAll(".date-tab").forEach((tab) => {
          if (tab.getAttribute("data-date") === date) {
            tab.classList.add("selected");
          } else {
            tab.classList.remove("selected");
          }
        });

        const dateSlots = timeSlotsData.filter((slot) => slot.date === date);
        displayTimeSlots(dateSlots);
      }

      // Display time slots for selected date
      function displayTimeSlots(slots) {
        const timeSlotsContainer = document.getElementById(
          "time-slots-container"
        );
        timeSlotsContainer.innerHTML = "";

        if (slots.length === 0) {
          timeSlotsContainer.innerHTML = `
              <div class="text-center py-4 col-span-2">
                <p class="text-gray-500">No time slots available for this date</p>
              </div>
            `;
          return;
        }

        slots.forEach((slot) => {
          const slotElement = document.createElement("label");
          const isAvailable =
            slot.available && slot.currentOrders < slot.maxOrders;
          const slotsLeft = slot.maxOrders - slot.currentOrders;

          slotElement.className = `time-slot ${
            !isAvailable ? "unavailable" : ""
          }`;

          if (!isAvailable) {
            slotElement.innerHTML = `
                <input type="radio" name="time-slot" value="${slot.id}" disabled />
                <div>
                  <div class="font-medium text-gray-500">${slot.time}</div>
                  <div class="text-xs text-red-500 mt-1">Fully Booked</div>
                </div>
              `;
          } else {
            slotElement.innerHTML = `
                <input type="radio" name="time-slot" value="${slot.id}" />
                <div>
                  <div class="font-medium text-green-800">${slot.time}</div>
                  <div class="text-xs text-green-600 mt-1">${slotsLeft} slot${
              slotsLeft !== 1 ? "s" : ""
            } left</div>
                </div>
              `;
          }

          timeSlotsContainer.appendChild(slotElement);
        });

        // Add event listeners to time slot radio buttons
        document
          .querySelectorAll('input[name="time-slot"]')
          .forEach((radio) => {
            radio.addEventListener("change", function () {
              if (this.checked && this.disabled === false) {
                selectedTimeSlot = this.value;

                document.querySelectorAll(".time-slot").forEach((slot) => {
                  slot.classList.remove("selected");
                });
                this.parentElement.classList.add("selected");
              }
            });
          });

        selectedTimeSlot = null;
      }

      // Handle delivery method selection
      function handleDeliveryMethodChange(method) {
        selectedDeliveryMethod = method;

        if (method === "pickup") {
          pickupOption.classList.add("selected");
          deliveryOption.classList.remove("selected");
          shippingAddressSection.style.display = "none";
          pickupTimeSlotsSection.classList.remove("hidden");

          document.getElementById("address").removeAttribute("required");
          document.getElementById("city").removeAttribute("required");
          document.getElementById("province").removeAttribute("required");
          document.getElementById("zip-code").removeAttribute("required");

          paymentInstruction.textContent =
            "Pay when you pick up your order at our store.";
          confirmOrderText.textContent = "Place Order (Pickup)";

          loadPickupTimeSlots();
        } else {
          deliveryOption.classList.add("selected");
          pickupOption.classList.remove("selected");
          shippingAddressSection.style.display = "block";
          pickupTimeSlotsSection.classList.add("hidden");

          document
            .getElementById("address")
            .setAttribute("required", "required");
          document.getElementById("city").setAttribute("required", "required");
          document
            .getElementById("province")
            .setAttribute("required", "required");
          document
            .getElementById("zip-code")
            .setAttribute("required", "required");

          paymentInstruction.textContent =
            "Our delivery partner will collect payment when your plants are delivered.";
          confirmOrderText.textContent = "Place Order (COD)";

          selectedTimeSlot = null;
          selectedDate = null;
        }

        updateCartTotals();
      }

      // SIMPLIFIED Checkout function - Fixed version
      function processCheckout(event) {
        event.preventDefault();

        if (Object.keys(cartItems).length === 0) {
          alert("Your cart is empty.");
          return;
        }

        // Basic validation
        const firstName = document.getElementById("first-name").value;
        const lastName = document.getElementById("last-name").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;

        if (!firstName || !lastName || !email || !phone) {
          alert("Please fill in all required customer information fields.");
          return;
        }

        if (!termsCheckbox.checked) {
          alert("Please agree to the Terms and Conditions to proceed.");
          return;
        }

        // Validate pickup time slot if pickup is selected
        if (selectedDeliveryMethod === "pickup") {
          if (!selectedTimeSlot || !selectedDate) {
            alert("Please select a pickup date and time slot.");
            return;
          }
        }

        // Validate address if delivery is selected
        if (selectedDeliveryMethod === "delivery") {
          const address = document.getElementById("address").value;
          const city = document.getElementById("city").value;
          const province = document.getElementById("province").value;
          const zipCode = document.getElementById("zip-code").value;

          if (!address || !city || !province || !zipCode) {
            alert("Please fill in all required shipping address fields.");
            return;
          }
        }

        // Show loading state
        const confirmButton = document.getElementById("confirm-order");
        const originalText = confirmButton.innerHTML;
        confirmButton.innerHTML =
          '<div class="loading mx-auto"></div> Processing...';
        confirmButton.disabled = true;

        const userId = getUserId();
        const totals = updateCartTotals();

        // Prepare order data
        const orderData = {
          userId: userId,
          customer: {
            firstName: firstName,
            lastName: lastName,
            email: email,
            phone: phone,
            deliveryMethod: selectedDeliveryMethod,
            paymentMethod: "cod",
          },
          items: cartItems,
          subtotal: totals.subtotal,
          shipping: totals.shipping,
          total: totals.total,
          status: "pending",
          createdAt: Date.now(),
          orderNumber: "ORD" + Date.now(),
          paymentMethod: "cod",
          deliveryMethod: selectedDeliveryMethod,
          statusHistory: [
            {
              status: "pending",
              timestamp: Date.now(),
              note: "Order placed successfully",
            },
          ],
        };

        // Add pickup details if pickup is selected
        if (selectedDeliveryMethod === "pickup") {
          const selectedSlot = timeSlotsData.find(
            (slot) => slot.id === selectedTimeSlot
          );
          orderData.customer.pickupDate = selectedSlot.date;
          orderData.customer.pickupTimeSlot = selectedSlot.time;
          orderData.customer.pickupTimeSlotId = selectedTimeSlot;
        } else {
          // Add shipping address if delivery is selected
          orderData.customer.address = document.getElementById("address").value;
          orderData.customer.city = document.getElementById("city").value;
          orderData.customer.province =
            document.getElementById("province").value;
          orderData.customer.zipCode =
            document.getElementById("zip-code").value;

          // Save address if requested
          if (saveAddressCheckbox.checked && currentUser) {
            const label = addressLabelInput.value || "Home";
            saveAddressToProfile(label, orderData.customer);
          }
        }

        // Save order to Firebase
        if (!database) {
          alert("Database connection error. Please try again.");
          confirmButton.innerHTML = originalText;
          confirmButton.disabled = false;
          return;
        }

        const orderId = "order_" + Date.now();
        const orderRef = database.ref("orders/" + orderId);

        orderRef
          .set(orderData)
          .then(() => {
            console.log("Order saved successfully");

            // Clear cart after successful order
            const cartRef = database.ref("cart/" + userId);
            return cartRef.remove();
          })
          .then(() => {
            // Close modals
            closeCheckoutModal();
            closeCart();

            // Show success message
            let successMessage = `Order placed successfully!\n\nOrder ID: ${
              orderData.orderNumber
            }\nTotal: ₱${totals.total.toLocaleString()}\nPayment: Cash on Delivery\n\n`;

            if (selectedDeliveryMethod === "pickup") {
              const selectedSlot = timeSlotsData.find(
                (slot) => slot.id === selectedTimeSlot
              );
              const dateObj = new Date(selectedSlot.date);
              const formattedDate = dateObj.toLocaleDateString("en-PH", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              successMessage +=
                `You selected Store Pickup for:\n${formattedDate} at ${selectedSlot.time}\n\n` +
                "Please visit our store at:\n\n123 Plant Street, Green City, Metro Manila\nOpen: Mon-Sat, 9AM-6PM\n\n" +
                "Please bring your order ID and a valid ID for verification.";
            } else {
              successMessage +=
                "Thank you for your purchase! Our delivery partner will contact you for delivery details.";
            }

            alert(successMessage);

            // Reset form and selections
            checkoutForm.reset();
            selectedTimeSlot = null;
            selectedDate = null;
            handleDeliveryMethodChange("delivery");
          })
          .catch((error) => {
            console.error("Error creating order:", error);
            alert(
              "There was an error processing your order. Please try again."
            );
          })
          .finally(() => {
            // Reset button state
            confirmButton.innerHTML = originalText;
            confirmButton.disabled = false;
          });
      }

      // Save address to user profile
      function saveAddressToProfile(label, addressData) {
        if (!currentUser) return;

        const addressId = "addr_" + Date.now();
        const addressRef = database.ref(
          "addresses/" + currentUser.uid + "/" + addressId
        );

        const address = {
          label: label,
          street: addressData.address,
          city: addressData.city,
          province: addressData.province,
          zipCode: addressData.zipCode,
          default: false, // Don't set as default automatically
          createdAt: Date.now(),
        };

        addressRef.set(address).then(() => {
          console.log("Address saved to profile");
        });
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // Check if Firebase is initialized
        if (!database) {
          console.error(
            "Firebase not initialized. Please check your Firebase configuration."
          );
          // You might want to show a user-friendly message here
        }

        // Set up authentication state observer
        auth.onAuthStateChanged((user) => {
          currentUser = user;
          updateUserUI();
          loadCart();
        });

        loadCategories();
        loadAllPlants();

        // Fallback: if plants don't load after 8 seconds, show error
        setTimeout(() => {
          if (Object.keys(plantsData).length === 0) {
            console.warn("Plants not loaded after 8 seconds, showing error message");
            const allPlantsContainer = document.getElementById("all-plants-container");
            const featuredContainer = document.getElementById("featured-plants-container");
            if (allPlantsContainer) {
              allPlantsContainer.innerHTML = `
                <div class="text-center py-12 col-span-full">
                  <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
                  <p class="text-gray-600 mb-2">Plants are taking a while to load...</p>
                  <p class="text-sm text-gray-500">Check console (F12) for errors. Make sure Firebase has data at /plants path.</p>
                </div>
              `;
            }
            if (featuredContainer) {
              featuredContainer.innerHTML = "";
            }
          }
        }, 8000);

        document.addEventListener("click", function (e) {
          if (e.target.closest(".add-to-cart")) {
            const button = e.target.closest(".add-to-cart");
            e.preventDefault();
            e.stopPropagation();

            if (!button.disabled) {
              const plantId = button.getAttribute("data-plant-id");
              addToCart(plantId);
            }
          }
        });

        // Search UI behavior
        if (openSearchBtn) {
          openSearchBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            // On small screens open modal, on larger screens toggle inline
            if (window.innerWidth < 768 && mobileSearchModal) {
              mobileSearchModal.classList.remove("hidden");
              document.body.style.overflow = "hidden";
              // focus
              setTimeout(() => {
                if (mobileSearchInput) mobileSearchInput.focus();
              }, 50);
              return;
            }

            if (searchWrapper) {
              searchWrapper.classList.toggle("hidden");
              if (!searchWrapper.classList.contains("hidden") && searchInput) {
                searchInput.focus();
              }
            }
          });

          // Close inline search when clicking outside (only for md+ inline)
          document.addEventListener("click", function (e) {
            if (searchWrapper && !searchWrapper.classList.contains("hidden") && !searchWrapper.contains(e.target) && e.target !== openSearchBtn) {
              searchWrapper.classList.add("hidden");
              const sr = document.getElementById('search-results');
              if (sr) sr.classList.add('hidden');
            }
          });

          // Clear inline search
          if (clearSearchBtn) {
            clearSearchBtn.addEventListener("click", function (e) {
              e.stopPropagation();
              if (searchInput) searchInput.value = "";
              if (searchWrapper) searchWrapper.classList.add("hidden");
              // hide live results
              const sr = document.getElementById('search-results');
              if (sr) sr.classList.add('hidden');
              searchPlants("");
            });
          }

          // Close mobile modal
          if (mobileSearchClose) {
            mobileSearchClose.addEventListener("click", function () {
              if (mobileSearchModal) mobileSearchModal.classList.add("hidden");
              document.body.style.overflow = "auto";
            });
          }

          if (mobileSearchClear) {
            mobileSearchClear.addEventListener("click", function () {
              if (mobileSearchInput) mobileSearchInput.value = "";
              const msr = document.getElementById('mobile-search-results');
              if (msr) msr.classList.add('hidden');
              searchPlants("");
            });
          }

          // Debounced input handler - run full search and render live dropdown
          const debounced = debounce(function (e) {
            const q = e.target.value || '';
            try {
              renderLiveResults(q);
            } catch (err) {
              // ignore if render function not ready
            }
            searchPlants(q);
          }, 250);

          // Separate debounced handler for mobile that also renders mobile results
          const mobileDebounced = debounce(function (e) {
            const q = e.target.value || '';
            console.debug("mobileDebounced: searching for", q);
            // Compute matches and render mobile results
            const matches = getSearchMatches(q, 12);
            console.debug("mobileDebounced: got", matches.length, "matches");
            const resultsObj = {};
            matches.forEach(({ id, plant }) => {
              resultsObj[id] = plant;
            });
            try {
              renderMobileSearchResults(resultsObj);
            } catch (err) {
              console.error('renderMobileSearchResults failed', err);
            }
            searchPlants(q);
          }, 250);

          if (searchInput) searchInput.addEventListener("input", debounced);
          if (mobileSearchInput) mobileSearchInput.addEventListener("input", mobileDebounced);


          // ESC to close inline or mobile
          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              if (searchWrapper) searchWrapper.classList.add("hidden");
              const sr = document.getElementById('search-results');
              if (sr) sr.classList.add('hidden');
              if (mobileSearchModal) {
                mobileSearchModal.classList.add("hidden");
                document.body.style.overflow = "auto";
                if (mobileSearchInput) mobileSearchInput.value = "";
                searchPlants("");
              }
            }
          });
        }

        // Cart button click
        document.getElementById("cart-btn").addEventListener("click", openCart);

        // Close cart buttons
        closeCartBtn.addEventListener("click", closeCart);
        cartBackdrop.addEventListener("click", closeCart);

        // User dropdown functionality
        userBtn.addEventListener("click", toggleUserDropdown);

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
            userDropdown.classList.remove("open");
          }
        });

        // User dropdown actions
        loginBtn.addEventListener("click", function () {
          openAuthModal();
          showLoginTab();
          userDropdown.classList.remove("open");
        });

        signupBtn.addEventListener("click", function () {
          openAuthModal();
          showSignupTab();
          userDropdown.classList.remove("open");
        });

        accountBtn.addEventListener("click", function () {
          openAccountModal();
          userDropdown.classList.remove("open");
        });

        ordersBtn.addEventListener("click", function () {
          openOrdersModal();
          userDropdown.classList.remove("open");
        });

        wishlistBtn.addEventListener("click", function () {
          openWishlistModal();
          userDropdown.classList.remove("open");
        });

        addressesBtn.addEventListener("click", function () {
          openAddressesModal();
          userDropdown.classList.remove("open");
        });

        logoutBtn.addEventListener("click", function () {
          handleLogout();
          userDropdown.classList.remove("open");
        });

        // Auth modal functionality
        closeAuthModalBtn.addEventListener("click", closeAuthModal);
        loginTab.addEventListener("click", showLoginTab);
        signupTab.addEventListener("click", showSignupTab);

        // Login form submission
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          handleLogin(email, password);
        });

        // Signup form submission
        signupForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const firstName = document.getElementById("signup-firstname").value;
          const lastName = document.getElementById("signup-lastname").value;
          const email = document.getElementById("signup-email").value;
          const password = document.getElementById("signup-password").value;
          const confirmPassword = document.getElementById(
            "signup-confirm-password"
          ).value;

          if (password !== confirmPassword) {
            alert("Passwords do not match");
            return;
          }

          handleSignup(firstName, lastName, email, password);
        });

        // Account modal functionality
        closeAccountModalBtn.addEventListener("click", closeAccountModal);
        viewOrdersBtn.addEventListener("click", function () {
          closeAccountModal();
          openOrdersModal();
        });

        viewWishlistBtn.addEventListener("click", function () {
          closeAccountModal();
          openWishlistModal();
        });

        manageAddressesBtn.addEventListener("click", function () {
          closeAccountModal();
          openAddressesModal();
        });

        logoutFromAccountBtn.addEventListener("click", handleLogout);

        // Orders modal functionality
        closeOrdersModalBtn.addEventListener("click", closeOrdersModal);
        closeOrdersBtn.addEventListener("click", closeOrdersModal);

        // Checkout button
        checkoutBtn.addEventListener("click", openCheckoutModal);

        // Checkout modal buttons
        closeCheckoutModalBtn.addEventListener("click", closeCheckoutModal);
        cancelCheckoutBtn.addEventListener("click", closeCheckoutModal);
        checkoutForm.addEventListener("submit", processCheckout);

        // Delivery method selection
        pickupOption.addEventListener("click", function () {
          handleDeliveryMethodChange("pickup");
        });

        deliveryOption.addEventListener("click", function () {
          handleDeliveryMethodChange("delivery");
        });

        // Saved addresses selection
        savedAddressSelect.addEventListener("change", function () {
          const addressId = this.value;
          if (addressId && savedAddresses[addressId]) {
            fillAddressForm(savedAddresses[addressId]);
          }
        });

        manageAddressesCheckoutBtn.addEventListener("click", function () {
          closeCheckoutModal();
          openAddressesModal();
        });

        // Save address checkbox
        saveAddressCheckbox.addEventListener("change", function () {
          if (this.checked && currentUser) {
            addressLabelSection.classList.remove("hidden");
          } else {
            addressLabelSection.classList.add("hidden");
          }
        });

        // Wishlist modal functionality
        closeWishlistModalBtn.addEventListener("click", closeWishlistModal);
        closeWishlistBtn.addEventListener("click", closeWishlistModal);

        // Addresses modal functionality
        closeAddressesModalBtn.addEventListener("click", closeAddressesModal);
        closeAddressesBtn.addEventListener("click", closeAddressesModal);
        addAddressBtn.addEventListener("click", openAddAddressModal);

        // Add address modal functionality
        closeAddAddressModalBtn.addEventListener("click", closeAddAddressModal);
        cancelAddAddressBtn.addEventListener("click", closeAddAddressModal);
        addAddressForm.addEventListener("submit", handleAddAddress);

        // Close with Escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCart();
            closeCheckoutModal();
            closeAuthModal();
            closeAccountModal();
            closeOrdersModal();
            closeWishlistModal();
            closeAddressesModal();
            closeAddAddressModal();
            userDropdown.classList.remove("open");
          }
        });
      });
    </script>
  </body>
</html>
